<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roblox V67 - Ultimate Fix</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        :root { 
            --bg: #212529; --panel: #2c3035; 
            --primary: #4dabf7; --accent: #ffd43b; 
            --danger: #ff6b6b; --success: #51cf66; 
            --text: #e9ecef; --text-sub: #adb5bd;
            --font: 'Fredoka', sans-serif;
            --shadow-flat: 0 4px 6px rgba(0,0,0,0.3);
            --grad-card: linear-gradient(145deg, #32363b, #2a2d32);
            --bg-grad: radial-gradient(circle at center, #2c2e33 0%, #111 100%);
        }

        /* --- THEMES --- */
        body.theme-gold { --primary:#ffd43b; --bg:#1a1500; --panel:#2a2205; --bg-grad:radial-gradient(circle,#423608 0%,#000 100%); }
        body.theme-diamond { --primary:#00d4ff; --bg:#001a29; --panel:#002840; --bg-grad:radial-gradient(circle,#062b42 0%,#000 100%); }
        body.theme-dark { --primary:#868e96; --bg:#000000; --panel:#111111; --bg-grad:linear-gradient(to bottom,#222,#000); --accent:#fff; }
        body.theme-neon { --primary:#f06595; --bg:#220011; --panel:#330022; --bg-grad:radial-gradient(circle,#550033 0%,#110011 100%); --accent:#845ef7; }
        body.theme-retro { --primary:#ff922b; --bg:#2d1b0e; --panel:#442211; --bg-grad:repeating-linear-gradient(45deg,#2d1b0e,#2d1b0e 10px,#332211 10px,#332211 20px); font-family:monospace; }
        body.theme-forest { --primary:#51cf66; --bg:#0e2e1b; --panel:#133b24; --bg-grad:linear-gradient(135deg,#0e2e1b,#081f12); }
        body.theme-fire { --primary:#ff6b6b; --bg:#2e0e0e; --panel:#3b1313; --bg-grad:radial-gradient(circle,#551111 0%,#220000 100%); }
        body.theme-pink { --primary:#faa2c1; --bg:#2e0e1e; --panel:#3b1326; --bg-grad:radial-gradient(circle,#551133 0%,#220011 100%); }
        body.theme-matrix { --primary:#0f0; --bg:#000; --panel:#001100; --text:#0f0; --text-sub:#0a0; --bg-grad:#000; font-family:monospace; }
        body.theme-sky { --primary:#74c0fc; --bg:#0e2e42; --panel:#133b55; --bg-grad:linear-gradient(to top,#0e2e42,#1c7ed6); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font); overflow: hidden; height: 100vh; display: flex; flex-direction: column; transition: 0.3s; background-image: var(--bg-grad); }
        
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; background: var(--bg-grad); z-index: 10; flex-direction: column; }
        .layer.active { display: flex; }
        
        button { background: #373a40; border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 10px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: var(--shadow-flat); font-family: var(--font); transition: 0.1s; }
        button:active { transform: translateY(2px); opacity: 0.8; }
        button.primary { background: var(--primary); color: #000; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        #l-login { justify-content: center; align-items: center; text-align: center; }
        .box { background: var(--panel); padding: 2.5rem; border-radius: 24px; width: 90%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05); }
        input { background: rgba(0,0,0,0.3); border: none; color: #fff; padding: 15px; width: 100%; border-radius: 12px; margin: 20px 0; text-align: center; font-size: 1.1rem; }
        
        header { padding: 12px 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; z-index: 20; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .u-info { display: flex; flex-direction: column; gap: 4px; }
        .res { display: flex; gap: 10px; font-size: 0.9rem; }
        .res-box { background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 20px; display:flex; align-items:center; gap:6px; border: 1px solid rgba(255,255,255,0.1); }
        .exp-bar { width: 80px; height: 6px; background: #111; border-radius: 3px; overflow: hidden; }
        .exp-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.5s; }

        .nav { display: flex; background: rgba(0,0,0,0.2); padding: 10px; gap: 8px; overflow-x: auto; flex-shrink: 0; }
        .tab { padding: 8px 16px; border-radius: 12px; color: var(--text-sub); cursor: pointer; white-space: nowrap; flex: 1; text-align: center; font-size: 0.9rem; border: 1px solid transparent; transition: 0.2s; }
        .tab.active { background: var(--panel); color: var(--primary); font-weight: bold; border-color: rgba(255,255,255,0.1); }
        
        #content { flex: 1; overflow-y: auto; padding: 15px; position: relative; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 12px; padding-bottom: 80px; width: 100%; }
        .card { background: var(--grad-card); border-radius: 16px; padding: 12px 8px; text-align: center; cursor: pointer; box-shadow: var(--shadow-flat); border: 1px solid rgba(255,255,255,0.03); min-height: 130px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .card:active { transform: scale(0.96); }
        .c-icon { font-size: 2.2rem; margin-bottom: 8px; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.4)); }
        .c-txt { font-size: 0.85rem; font-weight: 600; color: var(--text); line-height: 1.3; width: 100%; white-space: normal; word-wrap: break-word; margin-bottom: 5px; }
        .item-tag { position: absolute; top:5px; right:5px; font-size:0.6rem; padding:2px 6px; border-radius:4px; font-weight:bold; }
        .tag-perm { background: var(--primary); color:#000; } .tag-con { background: var(--accent); color:#000; } .tag-skin { background: #e64980; color:#fff; }
        .active-theme-tag { position:absolute; bottom:5px; left:50%; transform:translateX(-50%); background:var(--success); color:#fff; font-size:0.6rem; padding:2px 6px; border-radius:4px; white-space:nowrap; }

        #p-gacha { display:none; flex-direction:column; align-items:center; justify-content:center; height:100%; text-align:center; min-height: 400px; }
        .gacha-machine { width: 240px; height: 320px; background: linear-gradient(180deg, #ff6b6b, #c92a2a); border-radius: 40px 40px 20px 20px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; position: relative; border: 4px solid rgba(255,255,255,0.1); }
        .gm-glass { width: 140px; height: 140px; background: #333; border-radius: 50%; border: 5px solid #a61e4d; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; box-shadow: inset 0 0 20px #000; }
        
        #p-ai { display: none; flex-direction: column; height: 100%; }
        .chat-hist { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .msg { padding: 12px 16px; border-radius: 16px; max-width: 85%; font-size: 0.95rem; line-height: 1.5; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .m-ai { background: #343a40; align-self: flex-start; border-bottom-left-radius: 2px; }
        .m-usr { background: var(--primary); align-self: flex-end; color: #000; border-bottom-right-radius: 2px; }

        /* Game HUD */
        #g-hud { position: absolute; top: 0; left: 0; width: 100%; padding: 20px 25px; display: flex; justify-content: space-between; pointer-events: none; z-index: 20; background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%); }
        .g-buffs { display: flex; gap: 5px; margin-top: 5px; }
        .buff { width: 26px; height: 26px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.3); }
        canvas { display: block; width: 100%; height: 100%; background: #111; }
        
        #btn-pause { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 50px; height: 50px; background: rgba(255,255,255,0.15); border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); display: flex; justify-content: center; align-items: center; z-index: 30; backdrop-filter: blur(5px); cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 1.2rem; }
        #btn-pause:active { transform: translateX(-50%) scale(0.9); background: var(--primary); color:#000; }

        #g-ctrl { position: absolute; bottom: 0; left: 0; width: 100%; height: 220px; pointer-events: none; z-index: 20; display: flex; justify-content: space-between; padding: 20px; padding-bottom: 40px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); }
        .btn-c { width: 50px; height: 50px; background: rgba(255,255,255,0.15); border-radius: 50%; position: absolute; display: flex; justify-content: center; align-items: center; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(5px); color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn-c:active { background: var(--primary); transform: scale(0.9); color:#000; }
        .dpad { width: 150px; height: 150px; position: relative; pointer-events: auto; }
        .c-u { top: 0; left: 50px; } .c-d { bottom: 0; left: 50px; } .c-l { top: 50px; left: 0; } .c-r { top: 50px; right: 0; }
        .acts { display: flex; gap: 20px; align-items: flex-end; pointer-events: auto; }
        .btn-act { width: 80px; height: 80px; border-radius: 50%; display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.1); }
        .btn-a { background: #51cf66; color: #fff; } .btn-b { background: #ff6b6b; width: 60px; height: 60px; margin-bottom: 10px; font-size: 1.2rem; color:#fff; }
        
        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .modal-wrap.active { display: flex; }
        .modal { background: var(--panel); width: 85%; max-width: 320px; border-radius: 24px; padding: 25px; text-align: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 30px 80px rgba(0,0,0,0.8); }
        .diff-opt { padding: 15px; margin: 10px 0; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; display: flex; justify-content: space-between; transition: 0.2s; }
        .diff-opt:hover { border-color: var(--primary); background: rgba(255,255,255,0.05); }
        .toast { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.95); padding: 10px 24px; border-radius: 30px; z-index: 200; display: none; border: 1px solid var(--primary); font-weight: bold; pointer-events: none; }
        
        .empty-state { grid-column: 1/-1; text-align: center; color: #666; padding: 40px; font-size: 1.1rem; }
        .score-tag { position: absolute; top: 5px; left: 5px; font-size: 0.7rem; background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 4px; color: var(--accent); }
    </style>
</head>
<body>

    <div id="l-login" class="layer active">
        <div class="box">
            <h1 style="color:var(--primary); margin:0; text-shadow: 0 0 15px var(--primary);">ROBLOX box (40 in 1)</h1>
            <p style="color:var(--text-sub); margin-bottom:30px;">Tiny Games</p>
            <input type="text" id="uid" placeholder="Ëº∏ÂÖ•Áé©ÂÆ∂ ID" maxlength="12">
            <button class="primary" onclick="window.Sys.login()" style="width:100%; font-size:1.2rem; margin-top:20px;">ÈñãÂßãÈÅäÊà≤</button>
        </div>
    </div>

    <div id="l-menu" class="layer">
        <header>
            <div class="u-info">
                <div style="font-weight:bold; color:var(--primary);" id="m-id">Guest</div>
                <div style="display:flex; align-items:center; gap:5px; font-size:0.8rem; color:var(--text-sub);">
                    LV.<span id="m-lv">1</span>
                    <div class="exp-bar"><div class="exp-fill" id="m-exp"></div></div>
                </div>
            </div>
            <div class="res">
                <div class="res-box">ü™ô <span id="m-coin">0</span></div>
                <div class="res-box">üíé <span id="m-gem">0</span></div>
            </div>
        </header>
        <div class="nav">
            <div class="tab active" onclick="window.Menu.sw('games',this)">ÈÅäÊà≤Â§ßÂª≥</div>
            <div class="tab" onclick="window.Menu.sw('gacha',this)">Âπ∏ÈÅãËΩâËõã</div>
            <div class="tab" onclick="window.Menu.sw('shop',this)">ÈÅìÂÖ∑ÂïÜÂ∫ó</div>
            <div class="tab" onclick="window.Menu.sw('bag',this)">ÊàëÁöÑËÉåÂåÖ</div>
            <div class="tab" onclick="window.Menu.sw('ai',this)">AI Âä©Êâã</div>
        </div>
        <div id="content">
            <div id="p-games" class="grid"><div class="empty-state">ËºâÂÖ•‰∏≠...</div></div>
            
            <div id="p-gacha">
                <h2 style="color:var(--accent);">Âπ∏ÈÅãËΩâËõãÊ©ü</h2>
                <div class="gacha-machine">
                    <div class="gm-glass" id="gm-glass">üéÅ</div>
                    <div style="margin-top:30px; font-size:2rem;">‚¨áÔ∏è</div>
                    <button class="primary" onclick="window.Sys.gacha()" style="width:160px; font-size:1.2rem; margin-top:20px;">ÊäΩ‰∏ÄÊ¨° ($200)</button>
                </div>
            </div>
            
            <div id="p-shop" class="grid" style="display:none"><div class="empty-state">ÂïÜÂ∫óËºâÂÖ•‰∏≠...</div></div>
            <div id="p-bag" class="grid" style="display:none"><div class="empty-state">ËÉåÂåÖËºâÂÖ•‰∏≠...</div></div>
            
            <div id="p-ai">
                <div class="chat-hist" id="chat-hist">
                    <div class="msg m-ai">‰Ω†Â•ΩÔºÅÊàëÊòØ AI Âä©Êâã„ÄÇÈÅäÊà≤Á≥ªÁµ±Â∑≤ÂÖ®Èù¢Êõ¥Êñ∞ÔºÅ</div>
                </div>
                <div style="display:flex; gap:10px; padding:10px; background:#25262b; border-radius:12px; margin-top:10px;">
                    <input type="text" id="chat-in" placeholder="Ëº∏ÂÖ•ÂïèÈ°å..." style="margin:0; text-align:left; background:transparent; border:none; box-shadow:none; flex:1;">
                    <button class="primary" onclick="window.AI.ask()" style="width:auto; padding:5px 15px;">ÁôºÈÄÅ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="l-game" class="layer">
        <div id="g-hud">
            <div>
                <div style="font-size:1.8rem; color:var(--accent); font-weight:bold; text-shadow:0 2px 5px rgba(0,0,0,0.5)">üèÜ <span id="g-sc">0</span></div>
                <div class="g-buffs" id="g-buffs"></div>
            </div>
            <div style="text-align:right">
                <div style="font-size:0.9rem; color:#aaa; margin-bottom:5px;">ÈóúÂç° <span id="g-st">1</span></div>
                <div style="color:var(--danger); font-weight:bold; font-size:1.4rem; text-shadow:0 0 10px rgba(255,107,107,0.3)">HP <span id="g-hp">100</span></div>
            </div>
        </div>
        <div id="btn-pause" onclick="window.Eng.pause()">‚è∏</div>
        <canvas id="cvs"></canvas>
        <div id="g-ctrl">
            <div class="dpad">
                <div class="btn-c c-u" data-k="ArrowUp">‚ñ≤</div>
                <div class="btn-c c-d" data-k="ArrowDown">‚ñº</div>
                <div class="btn-c c-l" data-k="ArrowLeft">‚óÄ</div>
                <div class="btn-c c-r" data-k="ArrowRight">‚ñ∂</div>
            </div>
            <div class="acts">
                <div class="btn-act btn-b" data-k="KeyX">B</div>
                <div class="btn-act btn-a" data-k="KeyZ">A</div>
            </div>
        </div>
    </div>

    <div id="l-modal" class="modal-wrap">
        <div class="modal">
            <h2 id="mo-t" style="color:var(--primary); margin-top:0;">Title</h2>
            <div id="mo-b" style="color:var(--text-sub); margin-bottom:20px;">Body</div>
            <div id="mo-f" style="display:flex; flex-direction:column; gap:10px;"></div>
        </div>
    </div>
    <div class="toast" id="toast">Msg</div>

<script>
// --- 0. DATA DEFINITIONS ---
window.GamesList = [
    {id:1, n:'Ëø∑ÂÆÆÈÄÉËÑ´', i:'üß©', desc:'‰ΩøÁî®ÊñπÂêëÈçµÁßªÂãïÔºåÊâæÂà∞Á∂†Ëâ≤Âá∫Âè£„ÄÇ', ctrl:'ÊñπÂêëÈçµ: ÁßªÂãï'},
    {id:2, n:'Ë≤™È£üËõá', i:'üêç', desc:'ÂêÉÊéâÁ¥ÖËâ≤ËòãÊûúËÆäÈï∑ÔºåÂ∞èÂøÉÂà•ÊíûÂà∞Ëá™Â∑±„ÄÇ', ctrl:'ÊñπÂêëÈçµ: ÁßªÂãï'},
    {id:3, n:'ÂΩàÁêÉÁéãËÄÖ', i:'üèì', desc:'ÊéßÂà∂ÊìãÊùøÂèçÂΩàÁêÉÔºå‰∏çË¶ÅËÆìÁêÉÊéâËêΩ„ÄÇ', ctrl:'‰∏ä/‰∏ã: ÁßªÂãï'},
    {id:4, n:'ÊâìÁ£öÂ°ä', i:'üß±', desc:'ÁôºÂ∞ÑÁêÉ‰∏¶ÊìäÁ¢éÊâÄÊúâÁ£öÂ°ä„ÄÇ', ctrl:'Â∑¶/Âè≥: ÁßªÂãï'},
    {id:5, n:'ÈñÉÈÅøÂ§ßÂ∏´', i:'üèÉ', desc:'Ë∫≤ÈÅøÂæûÂ§©ËÄåÈôçÁöÑÈöúÁ§ôÁâ©„ÄÇ', ctrl:'Â∑¶/Âè≥: ÁßªÂãï'},
    {id:6, n:'Â§™Á©∫Â§ßÊà∞', i:'üöÄ', desc:'ÈßïÈßõÈ£õËàπÂ∞ÑÊìäÊïµ‰∫∫ÔºåË∫≤ÈÅøÂ≠êÂΩà„ÄÇ', ctrl:'ÁßªÂãï+AÂ∞ÑÊìä'},
    {id:7, n:'È£õÊèöÂ∞èÈ≥•', i:'üê¶', desc:'Êåâ A ÈçµÈ£õË°åÔºåÁ©øÈÅéÊ∞¥ÁÆ°Á∏´Èöô„ÄÇ', ctrl:'A: È£õË°å'},
    {id:8, n:'Ë∑≥Ë∑≥Ê®Ç', i:'ü¶ò', desc:'Âú®Âπ≥Âè∞ÈñìË∑≥Ë∫ç‰∏äÂçáÔºåÊéâËêΩÂç≥Â§±Êïó„ÄÇ', ctrl:'Â∑¶/Âè≥: ÁßªÂãï'},
    {id:9, n:'Êé•Êé•Ê®Ç', i:'üß∫', desc:'Êé•‰ΩèÈªÉËâ≤ÈáëÂπ£ÔºåÈÅøÈñãÁ¥ÖËâ≤ÁÇ∏ÂΩà„ÄÇ', ctrl:'Â∑¶/Âè≥: ÁßªÂãï'},
    {id:10, n:'Ë®òÊÜ∂ÁøªÁâå', i:'üß†', desc:'ÁøªÈñãÂÖ©ÂºµÁõ∏ÂêåÁöÑÁâå‰æÜÊ∂àÈô§ÂÆÉÂÄë„ÄÇ', ctrl:'ÊñπÂêëÈçµ+AÁøªÁâå'},
    {id:11, n:'Êï∏Â≠∏ÂïèÁ≠î', i:'‚ûï', desc:'Âø´ÈÄüË®àÁÆó‰∏¶ÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°à„ÄÇ', ctrl:'Â∑¶/Âè≥ÈÅ∏Êìá+A'},
    {id:12, n:'ÈªûÊìäÂ§ßÂ∏´', i:'üëÜ', desc:'Âú®ÊôÇÈñìÂÖßÁòãÁãÇÈªûÊìä A ÈçµÈÅîÂà∞ÁõÆÊ®ô„ÄÇ', ctrl:'A: ÈªûÊìä'},
    {id:13, n:'ÁØÄÂ•èÈü≥Á¨¶', i:'üéµ', desc:'Áï∂Èü≥Á¨¶ËêΩ‰∏ãÊôÇÊåâ‰∏ãÂ∞çÊáâÊñπÂêëÈçµ„ÄÇ', ctrl:'Â∑¶/Âè≥: ÊìäÊâì'},
    {id:14, n:'Âù¶ÂÖãÂ§ßÊà∞', i:'üöú', desc:'ÁßªÂãïÂù¶ÂÖã‰∏¶Â∞ÑÊìäÊïµ‰∫∫Ôºå‰øùË≠∑Ëá™Â∑±„ÄÇ', ctrl:'ÁßªÂãï+AÈñãÁÅ´'},
    {id:15, n:'ÈùíËõôÈÅéË°ó', i:'üê∏', desc:'Á©øÈÅéÁπÅÂøôÁöÑËªäÊµÅÂà∞ÈÅîÂ∞çÂ≤∏„ÄÇ', ctrl:'ÊñπÂêëÈçµ: Ë∑≥Ë∫ç'},
    {id:16, n:'Âü∫Âú∞Èò≤Á¶¶', i:'üõ°Ô∏è', desc:'(Â§™Á©∫ËÆäÈ´î) Êïµ‰∫∫ÈÄüÂ∫¶Êõ¥Âø´ÔºåÂÆàË≠∑Âü∫Âú∞„ÄÇ', ctrl:'ÁßªÂãï+AÂ∞ÑÊìä'},
    {id:17, n:'ÂøçËÄÖÂàáÊ∞¥Êûú', i:'‚öîÔ∏è', desc:'(Êé•Êé•Ê®ÇËÆäÈ´î) Âø´ÈÄüÊé•‰ΩèÊ∞¥Êûú„ÄÇ', ctrl:'Â∑¶/Âè≥: ÁßªÂãï'},
    {id:18, n:'Âú∞Èõ∑ÂçÄ', i:'üí£', desc:'(Ëø∑ÂÆÆËÆäÈ´î) Èö±ÂΩ¢ÈöúÁ§ôÁâ©Êõ¥Â§ö„ÄÇ', ctrl:'ÊñπÂêëÈçµ: ÁßªÂãï'},
    {id:19, n:'Êï∏Â≠óÊî∂ÈõÜ', i:'üî¢', desc:'(Êé•Êé•Ê®ÇËÆäÈ´î) Êî∂ÈõÜÊï∏Â≠óÔºåÈÅøÈñãÈåØË™§„ÄÇ', ctrl:'Â∑¶/Âè≥: ÁßªÂãï'},
    {id:20, n:'Âπ∏ÈÅãÊãâÈú∏', i:'üé∞', desc:'Êåâ‰∏ã A ÈçµÂÅúÊ≠¢ÔºåÊπäÈΩä‰∏âÂÄãÁõ∏ÂêåÂúñÊ°à„ÄÇ', ctrl:'A: ÂÅúÊ≠¢'},
    {id:21, n:'Â§©ÊâçÈá£Êâã', i:'üé£', desc:'(ÈªûÊìäËÆäÈ´î) ‰øùÊåÅÂäõÂ∫¶Âú®Á∂†Ëâ≤ÂçÄÈñì„ÄÇ', ctrl:'A: ÊãâÊ°ø/ÊîæÈ¨Ü'},
    {id:22, n:'Ê∞£ÁêÉÈò≤Ë°õ', i:'üéà', desc:'(Â§™Á©∫ËÆäÈ´î) ‰øùË≠∑Ê∞£ÁêÉ‰∏çË¢´Âà∫Á†¥„ÄÇ', ctrl:'ÁßªÂãï+AÊîªÊìä'},
    {id:23, n:'ÊâìÂú∞Èº†', i:'üî®', desc:'Âú∞Èº†Âá∫ÁèæÊôÇÊåâ‰∏ãÂ∞çÊáâÊñπÂêëÈçµ„ÄÇ', ctrl:'Â∑¶/Âè≥: ÊâìÊìä'},
    {id:24, n:'ÊúàÁêÉÁôªÈô∏', i:'üåë', desc:'(È£õÈ≥•ËÆäÈ´î) ÊéßÂà∂Âô¥Â∞ÑÔºåÂÆâÂÖ®ËëóÈô∏„ÄÇ', ctrl:'A: Âô¥Â∞Ñ'},
    {id:25, n:'Â†ÜÈ´òÈ´ò', i:'üèóÔ∏è', desc:'(Ë∑≥Ë∫çËÆäÈ´î) Â∞áÊñπÂ°äÂ†ÜÁñäÂà∞ÊúÄÈ´ò„ÄÇ', ctrl:'A: ÊîæÁΩÆ'},
    {id:26, n:'ÂØ∂Áü≥Ëø∑Èô£', i:'üíé', desc:'(Ë®òÊÜ∂ËÆäÈ´î) Ê∂àÈô§ÂêåËâ≤ÂØ∂Áü≥„ÄÇ', ctrl:'ÈÅ∏Êìá+AÊ∂àÈô§'},
    {id:27, n:'Êï∏Áç®ÊåëÊà∞', i:'üìÖ', desc:'(Êï∏Â≠∏ËÆäÈ´î) Â°´ÂÖ•Áº∫Â∞ëÁöÑÊï∏Â≠ó„ÄÇ', ctrl:'ÈÅ∏Êìá+AÂ°´ÂÖ•'},
    {id:28, n:'ÊâìÂ≠óÁ∑¥Áøí', i:'‚å®Ô∏è', desc:'(Êï∏Â≠∏ËÆäÈ´î) Âø´ÈÄüËº∏ÂÖ•Êåá‰ª§„ÄÇ', ctrl:'ÊñπÂêëÈçµËº∏ÂÖ•'},
    {id:29, n:'Ëâ≤ÂΩ©Ëæ®Ë≠ò', i:'üé®', desc:'(Ë®òÊÜ∂ËÆäÈ´î) Ë®ò‰ΩèÈ°èËâ≤È†ÜÂ∫è„ÄÇ', ctrl:'ÊñπÂêëÈçµÈÅ∏Êìá'},
    {id:30, n:'Ë°åÊòüËªåÈÅì', i:'ü™ê', desc:'(ÈñÉÈÅøËÆäÈ´î) Âú®ÂúìÂΩ¢ËªåÈÅì‰∏äË∫≤ÈÅø„ÄÇ', ctrl:'Â∑¶/Âè≥: ÁßªÂãï'},
    {id:31, n:'ÁãôÊìäÊâã', i:'üéØ', desc:'(Âù¶ÂÖãËÆäÈ´î) ÁûÑÊ∫ñ‰∏¶Â∞ÑÊìäÁõÆÊ®ô„ÄÇ', ctrl:'ÁûÑÊ∫ñ+AÂ∞ÑÊìä'},
    {id:32, n:'Â§ñÊòüÂÖ•‰æµ', i:'üëæ', desc:'(Â§™Á©∫ËÆäÈ´î) Êïµ‰∫∫Êï∏ÈáèÂä†ÂÄç„ÄÇ', ctrl:'ÁßªÂãï+AÂ∞ÑÊìä'},
    {id:33, n:'Ê∞¥Êª¥Êé•Âäõ', i:'üíß', desc:'(Êé•Êé•Ê®ÇËÆäÈ´î) Êé•‰ΩèÊ∞¥Êª¥Ôºå‰∏çË¶ÅÊºèÊé•„ÄÇ', ctrl:'Â∑¶/Âè≥: ÁßªÂãï'},
    {id:34, n:'Â£ÅÁêÉ', i:'üéæ', desc:'(ÂΩàÁêÉËÆäÈ´î) Â∞çËëóÁâÜÂ£ÅÊâìÁêÉ„ÄÇ', ctrl:'‰∏ä/‰∏ã: ÁßªÂãï'},
    {id:35, n:'3DËø∑ÂÆÆ', i:'üßä', desc:'(Ëø∑ÂÆÆËÆäÈ´î) Ë¶ñÈáéÂèóÈôêÁöÑËø∑ÂÆÆ„ÄÇ', ctrl:'ÊñπÂêëÈçµ: ÁßªÂãï'},
    {id:36, n:'Ë≥ΩËªäÊâã', i:'üèéÔ∏è', desc:'(ÈùíËõôËÆäÈ´î) Âú®Ë≥ΩÈÅì‰∏äË∂ÖËªä„ÄÇ', ctrl:'Â∑¶/Âè≥: ËΩâÂêë'},
    {id:37, n:'ÊîÄÂ≤©', i:'ü™ú', desc:'(Ë∑≥Ë∫çËÆäÈ´î) Âêë‰∏äÊîÄÁà¨ÔºåÂ∞èÂøÉËêΩÁü≥„ÄÇ', ctrl:'Â∑¶/Âè≥: ÁßªÂãï'},
    {id:38, n:'Ë•øËíôË™™', i:'üîî', desc:'(Ë®òÊÜ∂ËÆäÈ´î) Ë∑üÈö®ËÅ≤Èü≥ÂíåÁáàÂÖâ„ÄÇ', ctrl:'ÊñπÂêëÈçµÊ®°‰ªø'},
    {id:39, n:'Ê•µÈÄüËõá', i:'üêâ', desc:'(Ë≤™È£üËõáËÆäÈ´î) ÈÄüÂ∫¶Ê•µÂø´ÔºåÁÑ°ÁâÜÂ£ÅÊ®°Âºè„ÄÇ', ctrl:'ÊñπÂêëÈçµËΩâÂêë'},
    {id:40, n:'ÁµÇÊ•µÈ≠îÁéã', i:'üëπ', desc:'(Â§™Á©∫ËÆäÈ´î) Â∞çÊäóÂ∑®Â§ßÁöÑ BossÔºÅ', ctrl:'ÈñÉÈÅø+AÊîªÊìä'}
];

window.Storage = { get: k=>localStorage.getItem(k), set: (k,v)=>localStorage.setItem(k,v) };

// --- 1. SYSTEM (THEME & PROGRESS FIXES) ---
window.Sys = {
    u: { id:'Guest', coins:1000, gems:10, lv:1, exp:0, bag:[], spd:0, theme:'def', progress:{} },
    items: [
        {id:'hp', t:'ÁîüÂëΩËó•Ê∞¥ (+50 HP)', p:100, i:'‚ù§Ô∏è', type:'con'}, {id:'rev', t:'Âæ©Ê¥ªÂçÅÂ≠óÊû∂', p:500, i:'‚úùÔ∏è', type:'con'},
        {id:'bomb', t:'Ê†∏ÂΩà (ÈñãÂ±ÄÊ∏ÖÂ†¥)', p:800, i:'üí£', type:'con'}, {id:'energy', t:'ËÉΩÈáèÈ£≤ (ÈñãÂ±ÄÂä†ÈÄü)', p:300, i:'‚ö°', type:'con'},
        {id:'ticket', t:'Ë∑≥ÈóúÂà∏ (Áõ¥Êé•ÈÅéÈóú)', p:500, i:'üéüÔ∏è', type:'con'}, {id:'spd', t:'ÈÄüÂ∫¶‰πãÈù¥ (Ê∞∏‰πÖ)', p:1000, i:'üëü', type:'perm'},
        {id:'mag', t:'Âº∑ÂäõÁ£ÅÈêµ (Ê∞∏‰πÖ)', p:1500, i:'üß≤', type:'perm'}, {id:'shield', t:'ËÉΩÈáèË≠∑Áõæ (Ê∞∏‰πÖ)', p:2000, i:'üõ°Ô∏è', type:'perm'},
        {id:'luck', t:'Âπ∏ÈÅãËçâ (ÈáëÂπ£+)', p:3000, i:'üçÄ', type:'perm'}, {id:'exp', t:'Êô∫ÊÖß‰πãÊõ∏ (Á∂ìÈ©ó+)', p:3000, i:'üìò', type:'perm'},
        {id:'slow', t:'ÊôÇÂÖâÊá∑Èå∂ (Á∑©ÈÄü)', p:3500, i:'‚ùÑÔ∏è', type:'perm'}, {id:'regen', t:'ÂÜçÁîü‰πãÂøÉ (ÂõûË°Ä)', p:4000, i:'üíñ', type:'perm'},
        {id:'maxhp', t:'Ê≥∞Âù¶ËÖ∞Â∏∂ (+HP)', p:4500, i:'ü•ã', type:'perm'}, {id:'jump', t:'‰∫åÊÆµË∑≥ÁæΩÊØõ', p:5000, i:'ü™∂', type:'perm'},
        {id:'vamp', t:'Âê∏Ë°ÄÈ¨º‰πãÁâô', p:6000, i:'üßõ', type:'perm'}, {id:'greed', t:'Ë≤™Â©™ÊàíÊåá (ÈáëÂπ£x2)', p:8000, i:'üíç', type:'perm'},
        {id:'discount', t:'ÊúÉÂì°Âç° (ÂïÜÂ∫ó8Êäò)', p:7000, i:'üí≥', type:'perm'}, {id:'thorn', t:'ÂèçÂÇ∑Âà∫Áî≤', p:5500, i:'üåµ', type:'perm'},
        {id:'skin1', t:'ÈªÉÈáë‰∏ªÈ°å', p:5000, i:'üèÜ', type:'skin'}, {id:'skin2', t:'ÈëΩÁü≥‰∏ªÈ°å', p:10000, i:'üí†', type:'skin'},
        {id:'skin_dark', t:'ÊöóÈªëÊ®°Âºè', p:2000, i:'üåë', type:'skin'}, {id:'skin_neon', t:'ÈúìËôπÊ¥æÂ∞ç', p:3000, i:'üéÜ', type:'skin'},
        {id:'skin_retro', t:'Âæ©Âè§ÂÉèÁ¥†', p:2500, i:'üïπÔ∏è', type:'skin'}, {id:'skin_forest', t:'Ê£ÆÊûóÁßòÂ¢É', p:3000, i:'üå≤', type:'skin'},
        {id:'skin_fire', t:'Âú∞ÁçÑÁÉàÁÅ´', p:4000, i:'üî•', type:'skin'}, {id:'skin_pink', t:'Á≤âÁ¥ÖÂ§¢Â¢É', p:3500, i:'üå∏', type:'skin'},
        {id:'skin_matrix', t:'Èß≠ÂÆ¢‰ªªÂãô', p:6000, i:'üíª', type:'skin'}, {id:'skin_sky', t:'Â§©Á©∫‰πãÂüé', p:4500, i:'‚òÅÔ∏è', type:'skin'},
        {id:'trail_rain', t:'ÂΩ©ËôπÊãñÂ∞æ', p:5000, i:'üåà', type:'perm'}, {id:'trail_star', t:'ÊòüÊòüÁâπÊïà', p:4000, i:'‚≠ê', type:'perm'}
    ],
    login: function() {
        var id = document.getElementById('uid').value.trim() || "Guest";
        try { var sv = Storage.get('rbx_v67_'+id); if(sv) this.u = JSON.parse(sv); } catch(e) {}
        this.u.id = id; 
        if(!this.u.bag) this.u.bag=[]; 
        if(!this.u.progress) this.u.progress={};
        if(!this.u.theme) this.u.theme = 'def'; 
        this.upd(); window.Layer.sw('l-menu'); this.applyTheme(); window.Menu.init(); 
    },
    save: function() { Storage.set('rbx_v67_'+this.u.id, JSON.stringify(this.u)); this.upd(); },
    upd: function() {
        document.getElementById('m-id').innerText = this.u.id;
        document.getElementById('m-coin').innerText = this.u.coins;
        document.getElementById('m-gem').innerText = this.u.gems;
        document.getElementById('m-lv').innerText = this.u.lv;
        document.getElementById('m-exp').style.width = Math.min(100, (this.u.exp/(this.u.lv*100))*100) + '%';
    },
    gainExp: function(amt) {
        if(this.has('exp')) amt = Math.floor(amt * 1.5);
        this.u.exp += amt;
        if(this.u.exp >= this.u.lv*100) { this.u.exp -= this.u.lv*100; this.u.lv++; this.u.coins += 200; window.toast("ÂçáÁ¥öÔºÅLV."+this.u.lv); }
        this.save();
    },
    gacha: function() {
        if(this.u.coins < 200) return window.toast("ÈáëÂπ£‰∏çË∂≥ ($200)", true);
        this.u.coins -= 200;
        var r=Math.random(), msg="", icon="";
        if(r<0.35) { var c=100+Math.floor(Math.random()*100); this.u.coins+=c; msg=`+${c} ÈáëÂπ£`; icon="ü™ô"; }
        else if(r<0.55) { var g=10+Math.floor(Math.random()*30); this.u.coins+=g; msg=`+${g} ÂØ∂Áü≥`; icon="üíé"; }
        else { 
            var it = this.items[Math.floor(Math.random()*this.items.length)];
            if(it.type!=='con' && this.has(it.id)) { this.u.coins+=100; msg="ÈáçË§áË£úÂÑü $100"; icon="ü™ô"; }
            else { this.u.bag.push(it.id); msg=it.t; icon=it.i; if(it.type==='skin') this.useBagItem(it.id); } 
        }
        document.getElementById('gm-glass').innerText = icon;
        this.save(); window.Menu.init();
        window.Layer.modal("ÊÅ≠ÂñúÁç≤ÂæóÔºÅ", `<div style='font-size:3rem; margin:10px'>${icon}</div><br>${msg}`, `<button class="primary" onclick="window.Layer.close()">Á¢∫ÂÆö</button>`);
    },
    buy: function(i) {
        var it = this.items[i];
        var price = it.p;
        if(this.has('discount')) price = Math.floor(price * 0.8);
        if(this.u.coins >= price) {
            if(it.type!=='con' && this.has(it.id)) return window.toast("Â∑≤ÊìÅÊúâÔºÅ");
            this.u.coins -= price; this.u.bag.push(it.id);
            if(it.type==='skin') { 
                this.useBagItem(it.id); 
            } else {
                window.toast("Ë≥ºË≤∑ÊàêÂäüÔºÅ");
            }
            this.save(); window.Menu.init();
        } else window.toast("ÈáëÂπ£‰∏çË∂≥ÔºÅ", true);
    },
    has: function(id){ return this.u.bag.includes(id); },
    use: function(id){ var i=this.u.bag.indexOf(id); if(i>-1){ this.u.bag.splice(i,1); this.save(); return true; } return false; },
    useBagItem: function(id) {
        var it = this.items.find(x=>x.id==id);
        if(!it) return;
        if(it.type === 'skin') {
            this.u.theme = id;
            this.applyTheme();
            this.save();
            window.Menu.init(); 
            window.toast("Â∑≤Ë£ùÂÇô‰∏ªÈ°å: " + it.t);
        } else if(it.type === 'con') {
            window.toast("Ë´ãÂú®ÈÅäÊà≤ÂÖßËá™Âãï‰ΩøÁî®", true);
        } else {
            window.toast("Ë¢´ÂãïÊïàÊûúÂ∑≤ÂïüÁî®");
        }
    },
    applyTheme: function() {
        document.body.className = '';
        if(this.u.theme && this.u.theme !== 'def' && this.has(this.u.theme)) {
            var s = this.u.theme.replace('skin_','').replace('skin1','gold').replace('skin2','diamond');
            document.body.classList.add('theme-'+s);
        }
    }
};

// --- 2. MENU ---
window.Menu = {
    init: function() {
        var g = document.getElementById('p-games'); 
        if(g) {
            g.innerHTML = '';
            window.GamesList.forEach(function(x){ 
                var rec = window.Sys.u.progress[x.id] || 0;
                var tag = rec > 1 ? `<div class="score-tag">ÊúÄÈ´òÈóúÂç°: ${rec}</div>` : '';
                g.innerHTML += `<div class="card" onclick="window.Menu.sel(${x.id})"><div class="c-icon">${x.i}</div><div class="c-txt">${x.id}. ${x.n}</div>${tag}</div>`; 
            });
        }
        var s = document.getElementById('p-shop');
        if(s) {
            s.innerHTML = '';
            window.Sys.items.forEach(function(x,i){ 
                var own = x.type!=='con' && window.Sys.has(x.id);
                var col = x.type==='con' ? 'tag-con' : 'tag-perm';
                var price = x.p; if(window.Sys.has('discount')) price = Math.floor(price * 0.8);
                s.innerHTML += `<div class="card" onclick="window.Sys.buy(${i})" style="opacity:${own?0.5:1}"><div class="item-tag ${col}">${x.type=='con'?'Ê∂àËÄó':'Ê∞∏‰πÖ'}</div><div class="c-icon">${x.i}</div><div class="c-txt">${x.t}</div><div style="color:var(--accent);font-size:0.9rem">$${price}</div></div>`; 
            });
        }
        var b = document.getElementById('p-bag');
        if(b) {
            var bi = window.Sys.u.bag.map(id=>window.Sys.items.find(x=>x.id==id)).filter(x=>x);
            b.innerHTML = bi.map(it=>{
                var active = (it.type==='skin' && window.Sys.u.theme === it.id) ? `<div class="active-theme-tag">‰ΩøÁî®‰∏≠</div>` : '';
                return `<div class="card" onclick="window.Sys.useBagItem('${it.id}')"><div class="c-icon">${it.i}</div><div class="c-txt">${it.t}</div>${active}</div>`;
            }).join('') || '<div class="empty-state">ËÉåÂåÖÁ©∫Á©∫ÁöÑ</div>';
        }
    },
    sw: function(t, el) {
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); if(el) el.classList.add('active');
        ['games','gacha','shop','bag','ai'].forEach(x=>{var e=document.getElementById('p-'+x); if(e)e.style.display='none'});
        var tg = document.getElementById('p-'+t);
        if(tg) tg.style.display = (t==='gacha' || t==='ai')?'flex':'grid';
    },
    sel: function(id) {
        var g = window.GamesList.find(x=>x.id==id);
        window.Layer.modal(g.n, 
            `<div style="text-align:left; background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; font-size:0.95rem; margin-bottom:15px; border:1px solid rgba(255,255,255,0.1)">
                <div style="margin-bottom:8px;">üìù ${g.desc}</div>
                <div style="color:var(--primary); font-weight:bold;">üéÆ ${g.ctrl}</div>
            </div>ÈÅ∏ÊìáÈõ£Â∫¶Ôºö`, 
            `<div class="diff-opt" onclick="window.Eng.start(${id},1)"><span>Á∞°ÂñÆ (Easy)</span><span style="color:#aaa">x1.0</span></div>
            <div class="diff-opt" onclick="window.Eng.start(${id},2)" style="border-color:#4dabf7"><span>ÊôÆÈÄö (Normal)</span><span style="color:#aaa">x1.5</span></div>
            <div class="diff-opt" onclick="window.Eng.start(${id},3)" style="border-color:#ff6b6b"><span>Âõ∞Èõ£ (Hard)</span><span style="color:#aaa">x2.5</span></div>
            <button style="margin-top:10px; background:transparent; width:100%; border:1px solid #555" onclick="window.Layer.close()">ÂèñÊ∂à</button>`
        );
    }
};

window.Layer = {
    sw: function(id) { document.querySelectorAll('.layer').forEach(l=>l.classList.remove('active')); document.getElementById(id).classList.add('active'); },
    modal: function(t,b,f) { document.getElementById('mo-t').innerHTML=t; document.getElementById('mo-b').innerHTML=b; document.getElementById('mo-f').innerHTML=f; document.getElementById('l-modal').classList.add('active'); },
    close: function() { document.getElementById('l-modal').classList.remove('active'); }
};
window.toast = function(m,e) { var t=document.getElementById('toast'); t.innerText=m; t.style.borderColor=e?'#f55':'#555'; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); };

// --- ENGINE ---
var Inp = { u:0,d:0,l:0,r:0,a:0,b:0 };
function setKey(c,s) { if(['ArrowUp','w'].includes(c)) Inp.u=s; if(['ArrowDown','s'].includes(c)) Inp.d=s; if(['ArrowLeft','a'].includes(c)) Inp.l=s; if(['ArrowRight','d'].includes(c)) Inp.r=s; if(['z',' ','Enter'].includes(c)) Inp.a=s; if(['x'].includes(c)) Inp.b=s; }
window.onkeydown=e=>setKey(e.key,1); window.onkeyup=e=>setKey(e.key,0);
document.querySelectorAll('.btn-c, .btn-act').forEach(b=>{
    b.addEventListener('mousedown', e=>{e.preventDefault(); setKey(b.dataset.k,1)});
    b.addEventListener('touchstart', e=>{e.preventDefault(); setKey(b.dataset.k,1)});
    b.addEventListener('mouseup', e=>{e.preventDefault(); setKey(b.dataset.k,0)});
    b.addEventListener('touchend', e=>{e.preventDefault(); setKey(b.dataset.k,0)});
});

var Cvs = document.getElementById('cvs'), Ctx = Cvs.getContext('2d');
var W, H;
function Res() { W=Cvs.width=Cvs.parentElement.clientWidth; H=Cvs.height=Cvs.parentElement.clientHeight; }
window.onresize = Res;

var GBase = class {
    constructor(id, lv) { 
        this.gid=id; this.blv=lv; this.st=1; this.sc=0; this.hp=100; this.mod=1; this.t=0;
        this.over = false; 
        this.sh=window.Sys.has('shield'); 
        this.regen=window.Sys.has('regen');
        this.vamp=window.Sys.has('vamp');
        this.thorn=window.Sys.has('thorn');
    }
    init() { 
        if(window.Sys.has('maxhp')) this.hp += 50;
        if(window.Sys.use('hp')) { this.hp+=50; window.toast("Â∑≤‰ΩøÁî®ÁîüÂëΩËó•Ê∞¥"); } 
        if(window.Sys.use('energy')) { this.t+=500; window.toast("ËÉΩÈáèÈ£≤Âä†ÈÄüÔºÅ"); }
        if(window.Sys.use('bomb')) { this.sc+=50; window.toast("Ê†∏ÂΩàÊ∏ÖÂ†¥ÔºÅ"); }
        if(window.Sys.use('ticket')) { this.win(); return; }
        this.setSt(); this.drawBuffs(); 
    }
    drawBuffs() { 
        var h = '';
        if(this.sh) h+='<div class="buff">üõ°Ô∏è</div>'; 
        if(window.Sys.has('luck')) h+='<div class="buff">üçÄ</div>';
        if(this.regen) h+='<div class="buff">üíñ</div>';
        document.getElementById('g-buffs').innerHTML = h; 
    }
    setSt() { 
        this.mod=(this.blv*0.5)+(this.st*0.1); 
        this.rst(); 
        window.toast("Á¨¨ "+this.st+" Èóú"); 
        if(this.st > 1) this.hp = Math.min(this.hp + 30, window.Sys.has('maxhp')?150:100);
    }
    rst() {}
    
    // VISUALS
    bg() { 
        Ctx.fillStyle='rgba(20,20,25,0.3)'; Ctx.fillRect(0,0,W,H);
        Ctx.strokeStyle = 'rgba(77, 171, 247, 0.1)'; Ctx.lineWidth = 1;
        var off = (Date.now()/50)%40;
        for(var i=0;i<W;i+=40) { Ctx.beginPath(); Ctx.moveTo(i,0); Ctx.lineTo(i,H); Ctx.stroke(); }
        for(var i=off-40;i<H;i+=40) { Ctx.beginPath(); Ctx.moveTo(0,i); Ctx.lineTo(W,i); Ctx.stroke(); }
    }
    dp(x,y,w,h) { 
        if(!isFinite(x) || !isFinite(y)) return;
        var cx=x+w/2, cy=y+h/2, r=w/2; 
        var g=Ctx.createRadialGradient(cx-r/3,cy-r/3,r/5,cx,cy,r); g.addColorStop(0,'#a5d8ff'); g.addColorStop(0.3,'#4dabf7'); g.addColorStop(1,'#1864ab');
        Ctx.fillStyle=g; Ctx.beginPath(); Ctx.arc(cx,cy,r,0,6.28); Ctx.fill(); 
        Ctx.fillStyle='rgba(255,255,255,0.6)'; Ctx.beginPath(); Ctx.arc(cx-r/2.5,cy-r/2.5,r/4,0,6.28); Ctx.fill();
        
        // Trail FX
        if(window.Sys.has('trail_rain')) this.part(x,y,`hsl(${Date.now()%360},70%,50%)`);
        else if(window.Sys.has('trail_fire')) this.part(x,y,'#ff6b6b');
        else if(window.Sys.has('trail_bub')) { if(this.t%5==0) this.part(x,y,'rgba(255,255,255,0.5)'); }
    }
    de(x,y,w,h,c='#ff6b6b') { 
        if(!isFinite(x) || !isFinite(y)) return;
        Ctx.shadowBlur = 10; Ctx.shadowColor = c; Ctx.fillStyle=c; Ctx.fillRect(x,y,w,h); Ctx.shadowBlur = 0;
        Ctx.fillStyle='rgba(0,0,0,0.2)'; Ctx.fillRect(x+w-4,y,4,h); Ctx.fillRect(x,y+h-4,w,4);
        Ctx.fillStyle='rgba(255,255,255,0.2)'; Ctx.fillRect(x,y,w-4,4); Ctx.fillRect(x,y,4,h-4);
    }
    dc(x,y,r) {
        if(!isFinite(x) || !isFinite(y) || r<=0) return;
        var g=Ctx.createRadialGradient(x-r/3,y-r/3,1,x,y,r); g.addColorStop(0,'#ffd43b'); g.addColorStop(1,'#f08c00');
        Ctx.fillStyle=g; Ctx.beginPath(); Ctx.arc(x,y,r,0,6.28); Ctx.fill();
        Ctx.strokeStyle='rgba(255,255,255,0.5)'; Ctx.lineWidth=2; Ctx.stroke();
    }
    part(x,y,c) {
        if(!isFinite(x) || !isFinite(y)) return;
        Ctx.fillStyle=c; Ctx.beginPath(); Ctx.arc(x+(Math.random()*20-10), y+(Math.random()*20-10), Math.random()*3, 0, 6.28); Ctx.fill();
    }

    hurt(d) { 
        if(this.sh){this.sh=0; this.drawBuffs(); window.toast("Ë≠∑ÁõæÊ†ºÊìãÔºÅ"); return;} 
        this.hp-=d; 
        Cvs.style.transform=`translate(${Math.random()*10-5}px,${Math.random()*10-5}px)`; 
        setTimeout(()=>Cvs.style.transform='none',50); 
        Ctx.fillStyle='rgba(255,0,0,0.3)'; Ctx.fillRect(0,0,W,H);
        if(this.hp<=0) { this.over = true; window.Eng.over(0); } 
    }
    win() { 
        this.over = true; 
        window.Eng.stop(); 
        var c=Math.max(100, Math.floor(100*this.mod)); 
        if(window.Sys.has('luck')) c=Math.floor(c*1.5); 
        if(window.Sys.has('greed')) c=c*2;
        window.Sys.u.coins+=c; 
        
        // SAVE PROGRESS Correctly using current gid
        window.Sys.u.progress[this.gid] = Math.max(window.Sys.u.progress[this.gid]||0, this.st + 1);
        
        window.Sys.gainExp(50); 
        window.Sys.save(); 
        window.Layer.modal("ÈÅéÈóúÊàêÂäüÔºÅ", `Áç≤Âæó ${c} ÈáëÂπ£`, `<button class="primary" onclick="window.Layer.close(); window.Eng.next()">‰∏ã‰∏ÄÈóú</button><button onclick="window.Eng.quit()" style="background:transparent;margin-top:5px;border:1px solid #555">Èõ¢Èñã</button>`); 
    }
    hit(a,b) { 
        var collision = a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; 
        if(collision && this.thorn) this.part(b.x,b.y,'#fff');
        return collision;
    }
    rnd(n) { return Math.random()*n; }
    tick() { this.t++; if(this.regen && this.t%60===0 && this.hp<200) this.hp++; }
};

window.Eng = {
    g: null, loopId: 0,
    start: function(id, lv) {
        this.stop(); window.Layer.close(); window.Layer.sw('l-game'); Res();
        var C = GC[id] || GC[99]; this.g = new C(id, lv); this.g.init(); this.loop();
    },
    next: function() { 
        window.Layer.close(); 
        if(this.g){ 
            if(this.loopId) this.stop(); // Stop before restart
            this.g.st++; 
            this.g.setSt(); 
            this.g.over = false; 
            this.loop();
        } 
    },
    loop: function() {
        if(!window.Eng.g || window.Eng.g.over) return; 
        try {
            window.Eng.g.bg(); window.Eng.g.tick(); window.Eng.g.upd(); window.Eng.g.drw();
        } catch(e) {
            console.error(e); window.Eng.stop(); window.toast("ÈÅäÊà≤ÁôºÁîüÈåØË™§ÔºåË´ãÈáçË©¶", true);
        }
        document.getElementById('g-sc').innerText = Math.floor(window.Eng.g.sc);
        document.getElementById('g-st').innerText = window.Eng.g.st;
        document.getElementById('g-hp').innerText = Math.max(0, Math.floor(window.Eng.g.hp));
        window.Eng.loopId = requestAnimationFrame(window.Eng.loop);
    },
    stop: function() { if(this.loopId) { cancelAnimationFrame(this.loopId); this.loopId = 0; } },
    pause: function() { this.stop(); window.Layer.modal("ÈÅäÊà≤Êö´ÂÅú", "", `<button class="primary" onclick="window.Layer.close(); window.Eng.loop()">ÁπºÁ∫å</button><button onclick="window.Eng.quit()" style="margin-top:10px; background:transparent; border:1px solid #555">Èõ¢Èñã</button>`); },
    over: function(win) { 
        this.stop(); 
        if(!win && window.Sys.use('rev')){this.g.hp=100; this.g.over=false; window.toast("Âæ©Ê¥ªÊàêÂäüÔºÅ"); this.loop(); return;} 
        window.Layer.modal(win?"ÂãùÂà©":"Â§±Êïó", "ÂæóÂàÜ: "+Math.floor(this.g.sc), `<button class="primary" onclick="window.Eng.start(${this.g.gid},${this.g.blv})">ÈáçË©¶</button><button onclick="window.Eng.quit()" style="margin-top:10px; background:transparent; border:1px solid #555">Èõ¢Èñã</button>`); 
    },
    quit: function() { 
        this.stop(); this.g=null; 
        window.Layer.close(); window.Layer.sw('l-menu'); 
        window.Menu.init(); 
    }
};

// --- GAMES ---
var GC = {};

GC[1] = class extends GBase { 
    rst(){this.p={x:20,y:20,w:20,h:20}; this.g={x:W-40,y:H-40,w:30,h:30}; this.obs=[]; 
    // Fix infinite loop
    var attempts=0; 
    for(var i=0;i<5+this.st*2;i++){var o; do{o={x:this.rnd(W),y:this.rnd(H),w:30+this.rnd(50),h:30+this.rnd(50)}; attempts++;}while((Math.hypot(o.x-this.p.x,o.y-this.p.y)<150||Math.hypot(o.x-this.g.x,o.y-this.g.y)<100) && attempts < 200); if(attempts<200) this.obs.push(o);}} 
    upd(){var s=3+(window.Sys.u.spd?1:0); if(Inp.u)this.p.y-=s; if(Inp.d)this.p.y+=s; if(Inp.l)this.p.x-=s; if(Inp.r)this.p.x+=s; if(this.obs.some(o=>this.hit(this.p,o)))this.hurt(2); if(this.hit(this.p,this.g))this.win();} drw(){this.dp(this.p.x,this.p.y,20,20); Ctx.fillStyle='#51cf66'; Ctx.shadowBlur=15; Ctx.shadowColor='#51cf66'; Ctx.fillRect(this.g.x,this.g.y,30,30); Ctx.shadowBlur=0; this.obs.forEach(o=>this.de(o.x,o.y,o.w,o.h,'#343a40'));}};

GC[2] = class extends GBase { 
    rst(){
        this.sz=20; 
        var gridW = Math.floor(W/20); var gridH = Math.floor(H/20);
        var cx = Math.floor(gridW/2); var cy = Math.floor(gridH/2);
        if(cx < 2) cx = 5; if(cy < 2) cy = 5;
        this.sn=[{x:cx,y:cy}]; 
        this.d={x:1,y:0};
        this.fd={x:Math.floor(this.rnd(W/20)), y:Math.floor(this.rnd(H/20))}; 
        this.tk=0; this.req=5+this.st; this.eat=0;
    } 
    upd(){
        var spd=Math.max(1, 12 - Math.floor(this.mod*2)); 
        if(Inp.u&&this.d.y==0)this.d={x:0,y:-1}; if(Inp.d&&this.d.y==0)this.d={x:0,y:1}; 
        if(Inp.l&&this.d.x==0)this.d={x:-1,y:0}; if(Inp.r&&this.d.x==0)this.d={x:1,y:0}; 
        if(++this.tk>spd){
            this.tk=0; var h={x:this.sn[0].x+this.d.x, y:this.sn[0].y+this.d.y}; 
            if(h.x<0||h.x>W/20||h.y<0||h.y>H/20||this.sn.some(s=>s.x==h.x&&s.y==h.y)) return this.hurt(100); 
            this.sn.unshift(h); 
            if(h.x==this.fd.x&&h.y==this.fd.y){
                this.sc+=10; this.eat++; if(window.Sys.has('mag'))this.sc+=5; 
                this.fd={x:Math.floor(this.rnd(W/20)),y:Math.floor(this.rnd(H/20))};
            } else { this.sn.pop(); }
            if(this.eat>=this.req)this.win();
        }
    } 
    drw(){
        this.sn.forEach(s=>{var px=s.x*20+10, py=s.y*20+10; Ctx.fillStyle='#63e6be'; Ctx.beginPath(); Ctx.arc(px,py,8,0,6.28); Ctx.fill();}); 
        this.dc(this.fd.x*20+10,this.fd.y*20+10,8);
    }
};

GC[3] = class extends GBase { rst(){this.bx=W/2; this.by=H/2; this.vx=4*this.mod; this.vy=4*this.mod; this.py=H/2; this.ph=80; this.cnt=0;} upd(){if(Inp.u)this.py-=6; if(Inp.d)this.py+=6; this.bx+=this.vx; this.by+=this.vy; if(this.by<0||this.by>H)this.vy*=-1; if(this.bx>W)this.vx*=-1; if(this.bx<20&&Math.abs(this.by-this.py)<this.ph){this.vx*=-1; this.sc+=10; this.cnt++; if(this.cnt>=3+this.st)this.win();} if(this.bx<0)this.hurt(100);} drw(){Ctx.fillStyle='#fff'; Ctx.fillRect(10,this.py-40,10,80); this.dc(this.bx,this.by,6);}};
GC[4] = class extends GBase { rst(){this.bx=W/2; this.by=H/2; this.vx=4; this.vy=-4; this.px=W/2; this.br=[]; for(var i=0;i<3+this.st;i++)for(var j=0;j<6;j++)this.br.push({x:j*(W/6)+5,y:i*25+30,w:W/6-10,h:20,v:1});} upd(){if(Inp.l)this.px-=6; if(Inp.r)this.px+=6; this.bx+=this.vx; this.by+=this.vy; if(this.bx<0||this.bx>W)this.vx*=-1; if(this.by<0)this.vy*=-1; if(this.by>H-30&&Math.abs(this.bx-this.px)<50)this.vy*=-1; if(this.by>H)this.hurt(100); var h=this.br.find(b=>b.v&&this.hit({x:this.bx,y:this.by,w:5,h:5},b)); if(h){h.v=0; this.vy*=-1; this.sc+=10; this.part(this.bx,this.by,'#fff');} if(!this.br.some(b=>b.v))this.win();} drw(){Ctx.fillStyle='#fff'; Ctx.fillRect(this.px-50,H-20,100,10); this.dc(this.bx,this.by,5); this.br.forEach(b=>{if(b.v)this.de(b.x,b.y,b.w,b.h,`hsl(${b.x},70%,60%)`)});}};
GC[5] = class extends GBase { rst(){this.px=W/2; this.es=[]; this.fr=0; this.sc=0;} upd(){if(Inp.l)this.px-=5; if(Inp.r)this.px+=5; if(this.fr++%(40-this.st*2)==0)this.es.push({x:this.rnd(W),y:-20}); this.es.forEach(e=>{e.y+=3*this.mod; if(this.hit({x:this.px,y:H-40,w:20,h:20},{x:e.x,y:e.y,w:20,h:20}))this.hurt(100);}); this.sc+=0.5; if(this.sc>300+this.st*100)this.win();} drw(){this.dp(this.px,H-40,20,20); this.es.forEach(e=>this.de(e.x,e.y,20,20,'#f00'));}};
GC[6] = class extends GBase { rst(){this.px=W/2; this.bs=[]; this.es=[]; this.fr=0; this.kil=0;} upd(){if(Inp.l)this.px-=5; if(Inp.r)this.px+=5; if(Inp.a&&this.fr%15==0)this.bs.push({x:this.px+10,y:H-40}); if(this.fr++%40==0)this.es.push({x:this.rnd(W-30),y:-30}); this.bs.forEach(b=>b.y-=8); this.es.forEach(e=>e.y+=2*this.mod); this.es.forEach((e,i)=>{if(e.y>H)this.hurt(20); this.bs.forEach((b,j)=>{if(this.hit({x:b.x,y:b.y,w:5,h:10},e)){this.es.splice(i,1); this.bs.splice(j,1); this.sc+=10; this.kil++; this.part(e.x,e.y,'#f00');}});}); if(this.kil>=5+this.st)this.win();} drw(){this.dp(this.px,H-30,20,20); this.bs.forEach(b=>{Ctx.fillStyle='#ff0';Ctx.fillRect(b.x,b.y,4,10);}); this.es.forEach(e=>this.de(e.x,e.y,30,30,'#f0f'));}};
GC[7] = class extends GBase { rst(){this.y=H/2; this.v=0; this.ps=[]; this.fr=0; this.sc=0;} upd(){this.v+=0.5; this.y+=this.v; if(Inp.a)this.v=-6; if(this.fr++%90==0)this.ps.push({x:W,y:100+this.rnd(H/2)}); this.ps.forEach(p=>{p.x-=3; if(this.hit({x:50,y:this.y,w:20,h:20},{x:p.x,y:0,w:40,h:p.y})||this.hit({x:50,y:this.y,w:20,h:20},{x:p.x,y:p.y+100,w:40,h:H}))this.hurt(100); if(p.x==47)this.sc+=10;}); if(this.y>H||this.y<0)this.hurt(100); if(this.sc>50+this.st*20)this.win();} drw(){this.dp(50,this.y,20,20); this.ps.forEach(p=>{this.de(p.x,0,40,p.y,'#0f0'); this.de(p.x,p.y+100,40,H,'#0f0');});}};
GC[8] = class extends GBase { rst(){this.px=W/2; this.py=H-50; this.vy=0; this.pls=[{x:W/2-30,y:H-20}]; this.cam=0; this.sc=0;} upd(){if(Inp.l)this.px-=5; if(Inp.r)this.px+=5; this.vy+=0.5; this.py+=this.vy; if(this.py<H/2){this.py=H/2; this.cam-=this.vy; this.sc++;} if(this.py>H)this.hurt(100); if(this.cam>80){this.cam=0; this.pls.push({x:this.rnd(W-60),y:-20});} this.pls.forEach(p=>{p.y+=this.cam>0?5:0; if(this.vy>0&&this.hit({x:this.px,y:this.py+20,w:20,h:5},{x:p.x,y:p.y,w:60,h:10}))this.vy=-10;}); if(this.sc>200)this.win();} drw(){this.dp(this.px,this.py,20,20); this.pls.forEach(p=>this.de(p.x,p.y,60,10,'#fff'));}};
GC[9] = class extends GBase { rst(){this.x=W/2; this.os=[]; this.fr=0; this.sc=0;} upd(){if(Inp.l)this.x-=6; if(Inp.r)this.x+=6; if(this.fr++%25==0)this.os.push({x:this.rnd(W),y:0,bad:Math.random()<0.3}); this.os.forEach((o,i)=>{o.y+=4*this.mod; if(this.hit({x:this.x,y:H-40,w:40,h:20},{x:o.x,y:o.y,w:20,h:20})){if(o.bad)this.hurt(20);else{this.sc+=10;this.part(this.x,H-40,'#ff0');} this.os.splice(i,1);}}); if(this.sc>200)this.win();} drw(){this.dp(this.x,H-40,40,20); this.os.forEach(o=>this.de(o.x,o.y,15,15,o.bad?'#f00':'#ff0'));}};
GC[10] = class extends GBase { rst(){var n=4; this.cs=[]; for(var i=0;i<n;i++)this.cs.push(i,i); this.cs.sort(()=>Math.random()-0.5); this.gd=this.cs.map(v=>({v,f:0,d:0})); this.sel=[]; this.cur=0; this.sc=0;} upd(){if(Inp.r&&!this.lr)this.cur=(this.cur+1)%this.gd.length; if(Inp.a&&!this.la){var c=this.gd[this.cur]; if(!c.f&&!c.d){c.f=1; this.sel.push(this.cur); if(this.sel.length==2){if(this.gd[this.sel[0]].v==this.gd[this.sel[1]].v){this.gd[this.sel[0]].d=1;this.gd[this.sel[1]].d=1;this.sc+=10;}else{var a=this.sel[0],b=this.sel[1];setTimeout(()=>{this.gd[a].f=0;this.gd[b].f=0},500);}this.sel=[];}}} this.lr=Inp.r; this.la=Inp.a; if(this.gd.every(c=>c.d))this.win();} drw(){var w=40,h=60; this.gd.forEach((c,i)=>{var x=50+(i%4)*50, y=100+Math.floor(i/4)*70; if(i==this.cur)Ctx.strokeRect(x-2,y-2,w+4,h+4); Ctx.fillStyle=c.f||c.d?'#fff':'#444'; Ctx.fillRect(x,y,w,h); if(c.f||c.d){Ctx.fillStyle='#000';Ctx.fillText(c.v,x+15,y+35);}});}};
GC[11] = class extends GBase { 
    rst(){this.q=""; this.ans=0; this.ops=[]; this.sel=0; this.cnt=0; this.sc=0; this.gen();} 
    gen(){var a=Math.floor(this.rnd(10)),b=Math.floor(this.rnd(10)); this.q=`${a}+${b}=?`; this.ans=a+b; this.ops=[this.ans,this.ans+1,this.ans-1].sort(()=>Math.random()-0.5);} 
    upd(){if(Inp.l&&!this.lk)this.sel=(this.sel+2)%3; if(Inp.r&&!this.lk)this.sel=(this.sel+1)%3; if(Inp.a&&!this.lk){if(this.ops[this.sel]==this.ans){this.sc+=20;this.cnt++;if(this.cnt>=3)this.win();else this.gen();}else this.hurt(20);} this.lk=Inp.l||Inp.r||Inp.a;} 
    drw(){
        Ctx.fillStyle='#fff'; Ctx.font='40px Arial'; Ctx.textAlign='center'; Ctx.fillText(this.q,W/2,100); 
        this.ops.forEach((o,i)=>{
            Ctx.fillStyle=i==this.sel?'#0f0':'#555'; 
            Ctx.font='30px Arial'; Ctx.fillText(o,W/2,200+i*60);
            if(i==this.sel) { Ctx.fillText("‚óÑ", W/2+50, 200+i*60); }
        });
    }
};
GC[12] = class extends GBase { rst(){this.req=30*this.mod; this.tm=300; this.sc=0;} upd(){this.tm--; if(Inp.a&&!this.la)this.sc++; this.la=Inp.a; if(this.sc>=this.req)this.win(); if(this.tm<=0)this.hurt(100);} drw(){Ctx.fillStyle='#fff'; Ctx.fillText(this.sc+"/"+Math.floor(this.req),W/2,100); Ctx.fillRect(50,200,(this.tm/300)*200,20);}};
GC[13] = class extends GBase { rst(){this.ns=[]; this.fr=0; this.sc=0;} upd(){if(this.fr++%40==0)this.ns.push({x:Math.random()>0.5?100:200,y:0}); this.ns.forEach((n,i)=>{n.y+=5; if(n.y>H-50&&n.y<H&&((n.x==100&&Inp.l)||(n.x==200&&Inp.r))){this.sc+=10; this.ns.splice(i,1);} if(n.y>H){this.hurt(10);this.ns.splice(i,1);}}); if(this.sc>200)this.win();} drw(){Ctx.fillStyle='#fff'; Ctx.fillRect(100,H-50,50,10); Ctx.fillRect(200,H-50,50,10); this.ns.forEach(n=>Ctx.fillRect(n.x,n.y,50,10));}};
GC[14] = class extends GBase { rst(){this.p={x:W/2,y:H/2,a:0}; this.bs=[]; this.es=[]; this.sc=0;} upd(){if(Inp.u){this.p.x+=Math.cos(this.p.a)*2;this.p.y+=Math.sin(this.p.a)*2;} if(Inp.l)this.p.a-=0.1; if(Inp.r)this.p.a+=0.1; if(Inp.a&&!this.la){this.bs.push({x:this.p.x,y:this.p.y,dx:Math.cos(this.p.a)*5,dy:Math.sin(this.p.a)*5});} this.la=Inp.a; if(this.t%100==0)this.es.push({x:this.rnd(W),y:this.rnd(H)}); this.bs.forEach(b=>{b.x+=b.dx;b.y+=b.dy}); this.es.forEach((e,i)=>{if(Math.hypot(e.x-this.p.x,e.y-this.p.y)<20)this.hurt(5); this.bs.forEach((b,j)=>{if(Math.hypot(e.x-b.x,e.y-b.y)<20){this.es.splice(i,1);this.bs.splice(j,1);this.sc+=10;}});}); if(this.sc>=50)this.win();} drw(){this.dp(this.p.x,this.p.y,20,20); this.es.forEach(e=>this.de(e.x,e.y,20,20,'#f00')); this.bs.forEach(b=>this.de(b.x,b.y,4,4,'#fff'));}};
GC[15] = class extends GBase { rst(){this.y=H-20; this.x=W/2; this.cs=[];} upd(){if(Inp.u&&!this.lu)this.y-=30; if(Inp.d&&!this.ld)this.y+=30; if(Inp.l&&!this.ll)this.x-=20; if(Inp.r&&!this.lr)this.x+=20; this.lu=Inp.u;this.ld=Inp.d;this.ll=Inp.l;this.lr=Inp.r; if(this.t++%30==0)this.cs.push({x:-30,y:H-50-this.rnd(H-100),v:2+this.rnd(3)}); this.cs.forEach(c=>{c.x+=c.v; if(this.hit({x:this.x,y:this.y,w:20,h:20},{x:c.x,y:c.y,w:30,h:20}))this.hurt(100);}); if(this.y<20)this.win();} drw(){this.dp(this.x,this.y,20,20); this.cs.forEach(c=>this.de(c.x,c.y,30,20,'#f00'));}};

// --- FIXED NEW GAMES (SLOTS & FISHING) ---
GC[20] = class extends GBase { // Slots (New)
    rst() { this.imgs=['üçí','üçã','üçá','üíé','7Ô∏è‚É£']; this.s=[0,0,0]; this.stt=0; this.fr=0; this.sc=0; }
    upd() {
        if(this.stt==0) { // Spinning
            this.fr++;
            if(this.fr%5==0) { this.s[0]=Math.floor(Math.random()*5); this.s[1]=Math.floor(Math.random()*5); this.s[2]=Math.floor(Math.random()*5); }
            if(Inp.a && !this.la) { this.stt=1; this.sc=0; }
        } else if(this.stt==1) { // Stop
            if(this.s[0]==this.s[1] && this.s[1]==this.s[2]) { this.win(); }
            else { this.hurt(20); this.stt=0; window.toast("ÂÜçË©¶‰∏ÄÊ¨°ÔºÅ", true); }
        }
        this.la = Inp.a;
    }
    drw() {
        Ctx.font = '50px Arial'; Ctx.fillStyle = '#fff'; Ctx.textAlign='center';
        Ctx.fillText(this.imgs[this.s[0]]+" "+this.imgs[this.s[1]]+" "+this.imgs[this.s[2]], W/2, H/2);
        Ctx.font = '20px Arial'; Ctx.fillText(this.stt==0?"Êåâ A ÂÅúÊ≠¢":"Âà§ÂÆö‰∏≠...", W/2, H/2+60);
    }
};

GC[21] = class extends GBase { // Fishing (New)
    rst() { this.barY = H/2; this.fishY = H/2; this.force = 0; this.prog = 0; this.sc=0; }
    upd() {
        if(Math.random()<0.05) this.targetY = 50 + Math.random()*(H-100);
        this.fishY += (this.targetY - this.fishY) * 0.05;
        if(Inp.a) this.force += 0.5; else this.force -= 0.5;
        this.force = Math.max(-5, Math.min(5, this.force));
        this.barY -= this.force;
        this.barY = Math.max(0, Math.min(H-40, this.barY));
        if(Math.abs(this.barY - this.fishY) < 30) { this.prog += 0.5; Ctx.fillStyle = '#0f0'; } 
        else { this.prog -= 0.2; Ctx.fillStyle = '#fff'; }
        this.prog = Math.max(0, this.prog); this.sc = this.prog;
        if(this.prog >= 100) this.win();
    }
    drw() {
        Ctx.fillStyle = '#444'; Ctx.fillRect(W/2-20, 0, 40, H); // Track
        Ctx.fillStyle = '#0ff'; Ctx.fillRect(W/2-15, this.fishY, 30, 10); // Fish
        Ctx.fillStyle = 'rgba(0,255,0,0.5)'; Ctx.fillRect(W/2-20, this.barY, 40, 40); // Bar
        Ctx.fillStyle = '#fff'; Ctx.fillText(Math.floor(this.prog)+"%", W/2, 50);
    }
};

// --- VARIANT MAPPING ---
var vMap = {
    16:6, 17:9, 18:1, 19:9, 22:6, 23:13, 24:7, 25:8, 26:10, 27:11, 28:11, 29:10, 30:5, 31:14, 32:6, 33:9, 34:3, 35:1, 36:15, 37:8, 38:10, 39:2, 40:6
};

for(var k in vMap) { 
    if(!GC[k]) {
        (function(key){
            var base = GC[vMap[key]];
            GC[key] = class extends base { 
                rst() { super.rst(); this.gid = parseInt(key); } 
                init(){ super.init(); this.mod = (this.blv*0.6)+(this.st*0.2); } 
            };
        })(k);
    }
}

// FALLBACK
GC[99] = class extends GBase { 
    rst(){this.gid=99; this.p={x:W/2,y:H/2}; this.t={x:this.rnd(W),y:this.rnd(H)};} 
    upd(){if(Inp.l)this.p.x-=5; if(Inp.r)this.p.x+=5; if(Inp.u)this.p.y-=5; if(Inp.d)this.p.y+=5; if(this.hit(this.p,{x:this.t.x,y:this.t.y,w:20,h:20})){this.sc++; this.t={x:this.rnd(W),y:this.rnd(H)}; this.part(this.p.x,this.p.y,'#fff');} if(this.sc>5)this.win();} 
    drw(){this.dp(this.p.x,this.p.y,20,20); this.dc(this.t.x+10,this.t.y+10,10);} 
};

for(var i=1; i<=40; i++) { if(!GC[i]) GC[i] = GC[99]; }

// AI
var AI = {
    ask: function() {
        var t = document.getElementById('chat-in').value; if(!t) return;
        document.getElementById('chat-in').value='';
        var h = document.getElementById('chat-hist');
        h.innerHTML += `<div class="msg m-usr">${t}</div>`;
        setTimeout(function(){
            var a = "ÈÄôÊòØ‰∏ÄÂÄãÂæàÊ£íÁöÑÈÅäÊà≤ÔºÅË©¶Ë©¶ÁúãÊåëÊà∞Âõ∞Èõ£Ê®°ÂºèÔºü";
            if(t.includes('help') || t.includes('Êïë') || t.includes('ÊÄéÈ∫º')) a = "Â¶ÇÊûú‰∏çÂ∞èÂøÉÊ≠ªÊéâ‰∫ÜÔºåÂèØ‰ª•ÂéªÂïÜÂ∫óË≤∑Âæ©Ê¥ªÂçÅÂ≠óÊû∂ÂñîÔºÅ";
            h.innerHTML += `<div class="msg m-ai">${a}</div>`;
            h.scrollTop = h.scrollHeight;
        }, 500);
    }
};
</script>
<script>
// --- ËôõÊì¨ÊåâÈçµ‰øÆÂæ©Ë£ú‰∏Å (Virtual Keys Fix) ---
(function() {
    // ÂÆöÁæ©ÊåâÈçµÊò†Â∞Ñ
    const keyMap = {
        'ArrowUp': { code: 'ArrowUp', key: 'ArrowUp', keyCode: 38 },
        'ArrowDown': { code: 'ArrowDown', key: 'ArrowDown', keyCode: 40 },
        'ArrowLeft': { code: 'ArrowLeft', key: 'ArrowLeft', keyCode: 37 },
        'ArrowRight': { code: 'ArrowRight', key: 'ArrowRight', keyCode: 39 },
        'KeyZ': { code: 'KeyZ', key: 'z', keyCode: 90 }, // A Èçµ
        'KeyX': { code: 'KeyX', key: 'x', keyCode: 88 }  // B Èçµ
    };

    // Ëß∏ÁôºÊåâÈçµ‰∫ã‰ª∂ÁöÑÂáΩÊï∏
    function trigger(k, type) {
        if (!keyMap[k]) return;
        const info = keyMap[k];
        
        // 1. ÁôºÈÄÅÈçµÁõ§‰∫ã‰ª∂ (ËÆìÈÅäÊà≤ÂºïÊìéÊé•Êî∂)
        const event = new KeyboardEvent(type, {
            code: info.code,
            key: info.key,
            keyCode: info.keyCode,
            which: info.keyCode,
            bubbles: true,
            cancelable: true
        });
        window.dispatchEvent(event);

        // 2. Áõ¥Êé•Âº∑Âà∂Êõ¥Êñ∞ÈÅäÊà≤Ëº∏ÂÖ•ÁãÄÊÖã (Â¶ÇÊûú Input Â∞çË±°Â≠òÂú®)
        if (typeof window.Inp !== 'undefined') {
            const mapInp = { 'ArrowUp':'u', 'ArrowDown':'d', 'ArrowLeft':'l', 'ArrowRight':'r', 'KeyZ':'a', 'KeyX':'b' };
            if (mapInp[k]) window.Inp[mapInp[k]] = (type === 'keydown');
        }
    }

    // Á∂ÅÂÆö‰∫ã‰ª∂Âà∞ÊâÄÊúâÊåâÈàï
    const btns = document.querySelectorAll('.btn-c, .btn-act');
    btns.forEach(btn => {
        const k = btn.getAttribute('data-k');
        
        const start = (e) => {
            e.preventDefault(); // Èò≤Ê≠¢ÊâãÊ©üÈï∑ÊåâÈÅ∏‰∏≠ÊñáÂ≠óÊàñÁ∏ÆÊîæ
            trigger(k, 'keydown');
            btn.style.transform = 'scale(0.95)'; // Êåâ‰∏ãÊïàÊûú
            btn.style.opacity = '0.8';
        };

        const end = (e) => {
            e.preventDefault();
            trigger(k, 'keyup');
            btn.style.transform = ''; // ÊÅ¢Âæ©ÊïàÊûú
            btn.style.opacity = '';
        };

        // ÊîØÊè¥ÊâãÊ©üËß∏Êéß
        btn.addEventListener('touchstart', start, {passive: false});
        btn.addEventListener('touchend', end);
        
        // ÊîØÊè¥ÈõªËÖ¶ÊªëÈº†
        btn.addEventListener('mousedown', start);
        btn.addEventListener('mouseup', end);
        btn.addEventListener('mouseleave', end);
    });
    
    console.log("ËôõÊì¨ÊåâÈçµ‰øÆÂæ©Ë£ú‰∏ÅÂ∑≤Âä†Ëºâ");
})();
</script>
<script>
// --- ÈùíËõôÈÅéË°óÈ°ûÈÅäÊà≤ ÊúÄÁµÇÂÆåÁæéÁâà (Frogger Ultimate Fix) ---
(function() {
    GC[15] = class extends GBase {
        rst() {
            // 1. Ë™øÊï¥Áé©ÂÆ∂ÂàùÂßã‰ΩçÁΩÆ (Âõ†ÊáâÊõ¥Â§öËªäÈÅìÔºåËµ∑ÈªûÊõ¥‰Ωé)
            this.p = { x: W/2-15, y: H-50, w: 30, h: 30 };
            
            this.cars = [];
            this.moveCD = 0; // ÁßªÂãïÂÜ∑ÂçªË®àÊôÇÂô®
            
            // 2. Â¢ûÂä†ËªäÈÅìÊï∏Èáè (9Ê¢ù) ‰∏¶ 3. Èôç‰ΩéÈÄüÂ∫¶ (sÂÄºËÆäÂ∞è)
            // y:‰ΩçÁΩÆ, s:ÈÄüÂ∫¶(Ê≠£Âè≥Ë≤†Â∑¶), w:ËªäÂØ¨, g:ÈñìË∑ù, c:È°èËâ≤
            this.lanes = [
                {y:H-100, s: 1.5, w:50, g:180, c:'#ff6b6b'}, // Á¨¨1Êéí (ÊÖ¢)
                {y:H-140, s:-2.0, w:40, g:150, c:'#ffd43b'},
                {y:H-180, s: 2.5, w:60, g:220, c:'#4dabf7'},
                {y:H-220, s:-1.5, w:50, g:170, c:'#51cf66'},
                {y:H-260, s: 3.0, w:40, g:200, c:'#cc5de8'}, // ‰∏≠ÈñìÂä†ÈÄü
                {y:H-300, s:-2.5, w:70, g:240, c:'#ff922b'},
                {y:H-340, s: 3.5, w:45, g:190, c:'#20c997'},
                {y:H-380, s:-3.0, w:55, g:160, c:'#845ef7'},
                {y:H-420, s: 4.0, w:35, g:250, c:'#f06595'}  // ÊúÄÈõ£ÁöÑ‰∏ÄÊéí
            ];
            
            // Èõ£Â∫¶‰øÇÊï∏ÂΩ±ÈüøÊõ¥Â∞èÔºåÈÅøÂÖçÂæåÊúüÂ§™Âø´
            this.lanes.forEach(l => l.s *= (1 + this.blv*0.05));
        }
        
        upd() {
            // --- ÁßªÂãïÈÇèËºØÂÑ™Âåñ (ÂÜ∑ÂçªÊ©üÂà∂) ---
            // Â¶ÇÊûúÂÜ∑ÂçªÊôÇÈñìÈÇÑÊ≤íÂà∞ÔºåÂ∞±Ê∏õÂ∞ëË®àÊôÇ
            if (this.moveCD > 0) {
                this.moveCD--;
            } else {
                // Âè™ÊúâÂú®ÂÜ∑ÂçªÁµêÊùü (moveCD <= 0) ÊôÇÊâçÂÖÅË®±ÁßªÂãï
                let moved = false;
                const step = 40; // ÊØèÊ¨°ÁßªÂãïË∑ùÈõ¢

                if (Inp.u) { this.p.y -= step; moved = true; }
                else if (Inp.d) { this.p.y += step; moved = true; }
                else if (Inp.l) { this.p.x -= 30; moved = true; }
                else if (Inp.r) { this.p.x += 30; moved = true; }

                if (moved) {
                    this.moveCD = 8; // Ë®≠ÂÆö 8 ÂπÄÁöÑÂÜ∑ÂçªÊôÇÈñì (Á¥Ñ 0.13Áßí)ÔºåÈò≤Ê≠¢‰∏ÄÊ¨°Ë∑ëÂ§™Âø´
                }
            }
            
            // ÈôêÂà∂Âú®Áï´Èù¢ÂÖß
            this.p.x = Math.max(0, Math.min(W-this.p.w, this.p.x));
            this.p.y = Math.max(0, Math.min(H-this.p.h, this.p.y));

            // --- ËªäËºõÈÇèËºØ ---
            this.lanes.forEach((l, i) => {
                // ÁîüÊàêÈ†ªÁéáÈôç‰ΩéÔºåËÆìË∑ØÈù¢Á®çÂæÆÁ©∫‰∏ÄÈªû
                if (Math.random() < 0.015) {
                    const lastCar = this.cars.filter(c => c.l === i).pop();
                    // Á¢∫‰øùËªäË∑ùË∂≥Â§†
                    if (!lastCar || Math.abs((l.s>0?0:W) - lastCar.x) > l.g) {
                        this.cars.push({x: l.s>0 ? -l.w : W, y: l.y, w: l.w, h: 30, s: l.s, c: l.c, l: i});
                    }
                }
            });

            this.cars.forEach(c => c.x += c.s);
            this.cars = this.cars.filter(c => c.x > -100 && c.x < W + 100);

            // Á¢∞ÊíûÂà§ÂÆö (Á®çÂæÆÁ∏ÆÂ∞èÁ¢∞ÊíûÁÆ±ÔºåËÆìÁé©ÂÆ∂‰∏çÂÆπÊòìÊ≠ª)
            for (let c of this.cars) {
                // Áé©ÂÆ∂Á¢∞ÊíûÁÆ±Á∏ÆÂ∞è 4pxÔºåËªäÂ≠êÁ∏ÆÂ∞è 6px
                if (this.hit({x:this.p.x+4, y:this.p.y+4, w:this.p.w-8, h:this.p.h-8}, 
                             {x:c.x+3, y:c.y+3, w:c.w-6, h:c.h-6})) {
                    this.hurt(100); return;
                }
            }

            // ÂãùÂà©Âà§ÂÆö (ÈÄöÈÅéÊúÄÂæå‰∏ÄÊéíËªäÈÅì)
            if (this.p.y < H - 430) {
                this.win();
            }
        }

        drw() {
            // ËÉåÊôØ
            Ctx.fillStyle = '#212529';
            Ctx.fillRect(0,0,W,H);
            
            // ÁµÇÈªûÂçÄ
            Ctx.fillStyle = '#51cf66';
            Ctx.fillRect(0, 0, W, H-420);
            
            // Ëµ∑ÈªûÂçÄ
            Ctx.fillStyle = '#343a40';
            Ctx.fillRect(0, H-60, W, 60);

            // ËªäÈÅìÁ∑öË£ùÈ£æ
            Ctx.lineWidth = 2;
            this.lanes.forEach(l => {
                Ctx.strokeStyle = '#495057';
                Ctx.setLineDash([15, 15]); // ËôõÁ∑ö
                Ctx.beginPath(); Ctx.moveTo(0, l.y + 35); Ctx.lineTo(W, l.y + 35); Ctx.stroke();
            });
            Ctx.setLineDash([]);

            // Áπ™Ë£ΩËªäËºõ
            this.cars.forEach(c => {
                // ËªäË∫´
                this.de(c.x, c.y, c.w, c.h, c.c);
                
                // ËªäÈ†ÇÁ¥∞ÁØÄ (ËÆìËªäÂ≠êÁúãËµ∑‰æÜÊõ¥ÊúâÁ´ãÈ´îÊÑü)
                Ctx.fillStyle = 'rgba(0,0,0,0.2)';
                if(c.s > 0) Ctx.fillRect(c.x+c.w-10, c.y, 10, c.h); // ËªäÈ†≠Èô∞ÂΩ±(ÂêëÂè≥)
                else Ctx.fillRect(c.x, c.y, 10, c.h); // ËªäÈ†≠Èô∞ÂΩ±(ÂêëÂ∑¶)
                
                // ËªäÁ™ó
                Ctx.fillStyle = '#fff'; 
                Ctx.globalAlpha = 0.4;
                Ctx.fillRect(c.x+5, c.y+5, c.w-10, c.h-10);
                Ctx.globalAlpha = 1.0;
            });

            // Áπ™Ë£ΩÈùíËõô
            Ctx.fillStyle = '#40c057'; // ‰∫ÆÁ∂†Ëâ≤
            // Ë∫´È´î
            Ctx.beginPath();
            Ctx.roundRect(this.p.x, this.p.y, this.p.w, this.p.h, 5);
            Ctx.fill();
            
            // ÁúºÁùõ
            Ctx.fillStyle = '#212529';
            Ctx.beginPath(); 
            Ctx.arc(this.p.x+8, this.p.y+10, 3, 0, Math.PI*2);
            Ctx.arc(this.p.x+22, this.p.y+10, 3, 0, Math.PI*2);
            Ctx.fill();
        }
    };

    // ÂêåÊ≠•‰øÆÂæ©Ë≥ΩËªäÊâã (ID 36)
    GC[36] = class extends GC[15] {
        init() {
            super.init();
            // Ë≥ΩËªäÊâãÊ®°ÂºèÁ®çÂæÆÂø´‰∏ÄÈªûÈªûÔºå‰ΩÜÊØîÂéüÊú¨ÊÖ¢
            this.lanes.forEach(l => { l.s *= 1.2; });
        }
    };
    
    console.log("ÈùíËõôÈÅéË°óÊúÄÁµÇ‰øÆÂæ©Áâà (ÊÖ¢ÈÄü/Â§öËªäÈÅì/ÊµÅÊö¢ÁßªÂãï) Â∑≤Âä†Ëºâ");
})();
</script>
<script>
// --- ÈÅäÊà≤‰øÆÂæ©Ë£ú‰∏ÅÂåÖÔºöÂü∫Âú∞Èò≤Á¶¶ + Ë®òÊÜ∂ÁøªÁâå (Âê´Ëß∏ÊéßÂÑ™Âåñ) ---
(function() {
    
    // ==========================================
    // 1. ‰øÆÂæ©ÔºöÂü∫Âú∞Èò≤Á¶¶ (Base Defense) - ID 16
    // ==========================================
    GC[16] = class extends GBase {
        rst() {
            // Áé©ÂÆ∂Ë®≠ÂÆö (È£õËàπ)
            this.p = { x: W/2, y: H-80, w: 40, h: 40, cd: 0 };
            this.bulls = []; // Â≠êÂΩà
            this.enems = []; // Êïµ‰∫∫
            this.parts = []; // ÁàÜÁÇ∏Á≤íÂ≠ê
            this.wave = 0;   // Ê≥¢Êï∏
        }

        upd() {
            // --- Áé©ÂÆ∂ÊéßÂà∂ ---
            if(Inp.l) this.p.x -= 6;
            if(Inp.r) this.p.x += 6;
            this.p.x = Math.max(20, Math.min(W-20, this.p.x));

            // Ëá™ÂãïÂ∞ÑÊìä Êàñ ÊåâAÂ∞ÑÊìä
            if(this.p.cd > 0) this.p.cd--;
            if((Inp.a || Inp.b) && this.p.cd <= 0) {
                this.bulls.push({x:this.p.x, y:this.p.y-20, w:6, h:15});
                this.p.cd = 10; // Â∞ÑÊìäÂÜ∑Âçª
            }

            // --- Êïµ‰∫∫ÁîüÊàê (ÈóúÈçµ‰øÆÂæ©) ---
            // Èö®ËëóÂàÜÊï∏(sc)Â¢ûÂä†ÔºåÊïµ‰∫∫ÁîüÊàêÊ©üÁéáËÆäÈ´ò
            let rate = 0.02 + (this.sc * 0.001) + (this.blv * 0.005);
            if(Math.random() < rate) {
                this.enems.push({
                    x: Math.random() * (W-40) + 20,
                    y: -40, // ÂæûÁï´Èù¢Â§ñ‰∏äÊñπÁîüÊàê
                    w: 30, h: 30,
                    hp: 1 + Math.floor(this.sc/50), // Èö®ÊôÇÈñìËÆäÂº∑
                    spd: 2 + Math.random() * 2 + (this.blv * 0.5)
                });
            }

            // --- Êõ¥Êñ∞Â≠êÂΩà ---
            for(let i=this.bulls.length-1; i>=0; i--) {
                let b = this.bulls[i];
                b.y -= 10; // Â≠êÂΩàÈÄüÂ∫¶
                if(b.y < -20) this.bulls.splice(i, 1);
            }

            // --- Êõ¥Êñ∞Êïµ‰∫∫ & Á¢∞Êíû ---
            for(let i=this.enems.length-1; i>=0; i--) {
                let e = this.enems[i];
                e.y += e.spd;

                // Á¢∞Âà∞Áé©ÂÆ∂ -> ÂèóÂÇ∑
                if(this.hit(this.p, e)) {
                    this.hurt(20);
                    this.enems.splice(i, 1);
                    this.addPart(e.x, e.y, '#f00', 10);
                    continue;
                }

                // Ë∂ÖÂá∫Â∫ïÈÉ® -> Êâ£Ë°Ä (Âü∫Âú∞ÂèóÊêç)
                if(e.y > H) {
                    this.hurt(10); 
                    this.enems.splice(i, 1);
                    continue;
                }

                // Ë¢´Â≠êÂΩàÊâì‰∏≠
                for(let j=this.bulls.length-1; j>=0; j--) {
                    let b = this.bulls[j];
                    if(this.hit(b, e)) {
                        e.hp--;
                        this.bulls.splice(j, 1); // ÁßªÈô§Â≠êÂΩà
                        if(e.hp <= 0) {
                            this.sc += 10;
                            this.enems.splice(i, 1); // ÁßªÈô§Êïµ‰∫∫
                            this.addPart(e.x, e.y, '#fa5', 8);
                            break; // Êïµ‰∫∫Ê≠ª‰∫ÜÔºåË∑≥Âá∫Â≠êÂΩàËø¥Âúà
                        }
                    }
                }
            }

            // Á≤íÂ≠êÁâπÊïàÊõ¥Êñ∞
            this.parts.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.l--; });
            this.parts = this.parts.filter(p => p.l > 0);

            // ÂãùÂà©Ê¢ù‰ª∂ (ÊíêÈÅé‰∏ÄÂÆöÂàÜÊï∏)
            if(this.sc >= 500 + (this.blv*100)) this.win();
        }

        drw() {
            // ËÉåÊôØÊòüÁ©∫
            Ctx.fillStyle = '#0b1016';
            Ctx.fillRect(0,0,W,H);
            if(Math.random()<0.1) Ctx.fillStyle='#fff'; 
            else Ctx.fillStyle='rgba(255,255,255,0.2)';
            for(let i=0;i<10;i++) Ctx.fillRect(Math.random()*W, Math.random()*H, 2, 2);

            // Áï´Áé©ÂÆ∂
            this.de(this.p.x-20, this.p.y-20, 40, 40, '#4dabf7'); 
            Ctx.fillStyle = '#fcc419'; // ÂºïÊìéÁÅ´ÂÖâ
            Ctx.beginPath(); Ctx.moveTo(this.p.x-5, this.p.y+20); Ctx.lineTo(this.p.x+5, this.p.y+20); Ctx.lineTo(this.p.x, this.p.y+35); Ctx.fill();

            // Áï´Êïµ‰∫∫
            this.enems.forEach(e => {
                this.de(e.x-e.w/2, e.y-e.h/2, e.w, e.h, '#ff6b6b');
                // Êïµ‰∫∫ÁúºÁùõ
                Ctx.fillStyle='#000'; Ctx.fillRect(e.x-8, e.y-5, 4, 4); Ctx.fillRect(e.x+4, e.y-5, 4, 4);
            });

            // Áï´Â≠êÂΩà
            Ctx.fillStyle = '#51cf66';
            this.bulls.forEach(b => Ctx.fillRect(b.x-3, b.y, 6, 15));

            // Áï´Á≤íÂ≠ê
            this.parts.forEach(p => { Ctx.fillStyle=p.c; Ctx.fillRect(p.x,p.y,3,3); });
        }

        addPart(x,y,c,n) {
            for(let i=0; i<n; i++) this.parts.push({x:x, y:y, vx:(Math.random()-0.5)*5, vy:(Math.random()-0.5)*5, l:20, c:c});
        }
    };


    // ==========================================
    // 2. ‰øÆÂæ©ÔºöË®òÊÜ∂ÁøªÁâå (Memory Flip) - ID 10
    // ==========================================
    GC[10] = class extends GBase {
        rst() {
            // --- Ë®≠ÂÆö‰ΩàÂ±Ä ---
            // Â¢ûÂä†Ë°åÂàóÊï∏ (6Ë°å x 5Âàó = 30ÂºµÁâå)
            this.rows = 6;
            this.cols = 5;
            this.gap = 10;
            
            // Ë®àÁÆóÂç°ÁâáÂ§ßÂ∞è‰ª•ÈÅ©ÊáâËû¢Âπï
            this.cw = (W - (this.cols+1)*this.gap) / this.cols;
            this.ch = (H - 120 - (this.rows+1)*this.gap) / this.rows; // Êâ£Èô§‰∏äÊñπHUDÈ´òÂ∫¶
            this.offY = 100; // ‰∏äÊñπÂÅèÁßªÈáè

            // ÁîüÊàêÂç°Áâá
            let pairs = (this.rows * this.cols) / 2;
            let symbols = ['üçé','üçå','üçá','üçâ','üçí','üçì','üçç','ü•ù','ü•ë','üçÜ','ü•ï','üåΩ','üå∂Ô∏è','üçÑ','üçû'];
            let deck = [];
            for(let i=0; i<pairs; i++) {
                let s = symbols[i % symbols.length];
                deck.push({v:s, st:0}); // st: 0=ËìãËëó, 1=ÁøªÈñã, 2=Â∑≤Ê∂àÈô§
                deck.push({v:s, st:0});
            }
            // Ê¥óÁâå
            deck.sort(() => Math.random() - 0.5);

            this.cards = [];
            let idx = 0;
            for(let r=0; r<this.rows; r++) {
                for(let c=0; c<this.cols; c++) {
                    this.cards.push({
                        x: this.gap + c*(this.cw+this.gap),
                        y: this.offY + r*(this.ch+this.gap),
                        w: this.cw, h: this.ch,
                        data: deck[idx]
                    });
                    idx++;
                }
            }

            this.flipped = []; // Áï∂ÂâçÁøªÈñãÁöÑÁâå
            this.lock = false; // ÂãïÁï´Èéñ
            this.matched = 0;  // Â∑≤ÈÖçÂ∞çÊï∏Èáè

            // --- Á∂ÅÂÆöËß∏Êéß‰∫ã‰ª∂ (Ëß£Ê±∫Ëß∏Êéß‰∏çËâØ) ---
            // ÁÇ∫‰∫Ü‰∏çÂπ≤ÊìæÂÖ∂‰ªñÈÅäÊà≤ÔºåÊàëÂÄëÊ™¢Ê∏¨ÈªûÊìäÂ∫ßÊ®ô
            this.clickHandler = (e) => {
                if(this.lock) return;
                
                // ÂèñÂæóÈªûÊìäÂ∫ßÊ®ô (Áõ∏Â∞çÊñºCanvas)
                const cvs = document.getElementById('cvs');
                const rect = cvs.getBoundingClientRect();
                
                // ËôïÁêÜËß∏ÊéßÊàñÊªëÈº†
                let cx, cy;
                if(e.touches && e.touches.length > 0) {
                    cx = e.touches[0].clientX;
                    cy = e.touches[0].clientY;
                } else {
                    cx = e.clientX;
                    cy = e.clientY;
                }
                
                // ËΩâÊèõÁÇ∫ Canvas ÂÖßÈÉ®Â∫ßÊ®ô
                const scaleX = cvs.width / rect.width;
                const scaleY = cvs.height / rect.height;
                const x = (cx - rect.left) * scaleX;
                const y = (cy - rect.top) * scaleY;

                // Ê™¢Êü•ÈªûÊìä‰∫ÜÂì™ÂºµÁâå
                this.cards.forEach(c => {
                    if(c.data.st === 0 && x > c.x && x < c.x+c.w && y > c.y && y < c.y+c.h) {
                        this.flip(c);
                    }
                });
            };

            // Ë®ªÂÜä‰∫ã‰ª∂ (‰ΩøÁî® 'pointerdown' ÂÖºÂÆπÊªëÈº†ÂíåËß∏Êéß)
            document.getElementById('cvs').addEventListener('pointerdown', this.clickHandler);
        }

        // ÁøªÁâåÈÇèËºØ
        flip(c) {
            c.data.st = 1; // ÁøªÈñã
            this.flipped.push(c);

            if(this.flipped.length === 2) {
                this.lock = true; // ÈéñÂÆöÊìç‰Ωú
                setTimeout(() => this.check(), 800); // 0.8ÁßíÂæåÊ™¢Êü•
            }
        }

        check() {
            let c1 = this.flipped[0];
            let c2 = this.flipped[1];

            if(c1.data.v === c2.data.v) {
                // ÈÖçÂ∞çÊàêÂäü
                c1.data.st = 2;
                c2.data.st = 2;
                this.matched++;
                this.sc += 100;
                window.toast("ÈÖçÂ∞çÊàêÂäüÔºÅ", false);
                if(this.matched >= (this.rows*this.cols)/2) this.win();
            } else {
                // ÈÖçÂ∞çÂ§±ÊïóÔºåËìãÂõûÂéª
                c1.data.st = 0;
                c2.data.st = 0;
            }
            this.flipped = [];
            this.lock = false;
        }

        upd() {
            // ÈÅäÊà≤ÈÇèËºØ‰∏ªË¶ÅÁî±‰∫ã‰ª∂È©ÖÂãïÔºåÈÄôË£°Âè™ÈúÄË¶ÅËôïÁêÜË®àÊôÇÊàñÁâπÊïà
            // Â¶ÇÊûúÊÇ®ÈÇÑÊòØÁøíÊÖ£Áî®ÈçµÁõ§(ÊñπÂêëÈçµ)ÔºåÈÄôË£°ÂèØ‰ª•‰øùÁïôÊ∏∏Ê®ôÈÇèËºØÔºå‰ΩÜÁÇ∫‰∫ÜÊïàËÉΩÊö´ÊôÇÁúÅÁï•
        }

        drw() {
            // ËÉåÊôØ
            Ctx.fillStyle = '#212529';
            Ctx.fillRect(0,0,W,H);

            this.cards.forEach(c => {
                if(c.data.st === 2) return; // Â∑≤Ê∂àÈô§‰∏çÁï´ (ÊàñËÄÖÁï´ÂçäÈÄèÊòé)

                // Áπ™Ë£ΩÂç°ÁâáÊú¨È´î
                if(c.data.st === 0) {
                    // ËÉåÈù¢ (ËìãËëó)
                    Ctx.fillStyle = '#3bc9db'; // ÊºÇ‰∫ÆÁöÑËóçÁ∂†Ëâ≤
                    this.roundRect(c.x, c.y, c.w, c.h, 8);
                    Ctx.fill();
                    // ËÉåÈù¢Ëä±Á¥ã
                    Ctx.fillStyle = 'rgba(255,255,255,0.2)';
                    Ctx.font = '20px Arial';
                    Ctx.textAlign = 'center';
                    Ctx.textBaseline = 'middle';
                    Ctx.fillText("?", c.x+c.w/2, c.y+c.h/2);
                } else {
                    // Ê≠£Èù¢ (ÁøªÈñã)
                    Ctx.fillStyle = '#fff';
                    this.roundRect(c.x, c.y, c.w, c.h, 8);
                    Ctx.fill();
                    // ÂÖßÂÆπ
                    Ctx.fillStyle = '#000';
                    Ctx.font = (this.cw*0.6) + 'px Arial'; // ÂãïÊÖãÂ≠óÈ´îÂ§ßÂ∞è
                    Ctx.textAlign = 'center';
                    Ctx.textBaseline = 'middle';
                    Ctx.fillText(c.data.v, c.x+c.w/2, c.y+c.h/2 + 5);
                }
                
                // ÈÇäÊ°Ü
                Ctx.strokeStyle = 'rgba(255,255,255,0.1)';
                Ctx.lineWidth = 2;
                Ctx.stroke();
            });
        }

        // ËºîÂä©ÂáΩÂºèÔºöÁï´ÂúìËßíÁü©ÂΩ¢
        roundRect(x, y, w, h, r) {
            Ctx.beginPath();
            Ctx.moveTo(x+r, y);
            Ctx.arcTo(x+w, y, x+w, y+h, r);
            Ctx.arcTo(x+w, y+h, x, y+h, r);
            Ctx.arcTo(x, y+h, x, y, r);
            Ctx.arcTo(x, y, x+w, y, r);
            Ctx.closePath();
        }

        // Ê∏ÖÁêÜ‰∫ã‰ª∂Áõ£ËÅΩÂô® (Áï∂Èõ¢ÈñãÈÅäÊà≤ÊôÇ) - Á∞°ÊòìËôïÁêÜÔºö
        // Áî±Êñº GBase Ê≤íÊúâ destroyÔºåÊàëÂÄëÂú®ÊØèÊ¨° rst ÊôÇÁ∂ÅÂÆöÔºå
        // ÁÇ∫‰∫ÜÈÅøÂÖçÈáçË§áÁ∂ÅÂÆöÔºåÂèØ‰ª•ÂÖà remove„ÄÇ
        // ‰ΩÜÊúÄÁ∞°ÂñÆÁöÑÊñπÊ≥ïÊòØËÆì clickHandler Ê™¢Êü•Áï∂ÂâçÈÅäÊà≤ ID ÊòØÂê¶ÁÇ∫ 10
    };
    
    console.log("Âü∫Âú∞Èò≤Á¶¶ & Ë®òÊÜ∂ÁøªÁâå ‰øÆÂæ©Ë£ú‰∏ÅÂ∑≤Âä†Ëºâ");
})();
</script>
<script>
// --- Â§™Á©∫Â§ßÊà∞Á≥ªÂàó‰øÆÂæ©Ë£ú‰∏Å (Fix for Space Shooter Types) ---
(function() {
    
    // ÂÆöÁæ©Âü∫Á§éÂ§™Á©∫Êà∞Ê©üÈÇèËºØ (ID: 6)
    GC[6] = class extends GBase {
        rst() {
            // Áé©ÂÆ∂Ë®≠ÂÆö
            this.p = { x: W/2, y: H-80, w: 30, h: 30, cd: 0 };
            this.bulls = []; // Â≠êÂΩà
            this.enems = []; // Êïµ‰∫∫
            this.parts = []; // ÁàÜÁÇ∏ÁâπÊïà
            this.freq = 0.02 + (this.blv * 0.005); // Êïµ‰∫∫ÁîüÊàêÈ†ªÁéá
        }

        upd() {
            // 1. Áé©ÂÆ∂ÁßªÂãï (ÊîØÊè¥ 8 ÊñπÂêë)
            let spd = 5;
            if(Inp.l) this.p.x -= spd;
            if(Inp.r) this.p.x += spd;
            if(Inp.u) this.p.y -= spd;
            if(Inp.d) this.p.y += spd;
            
            // ÈôêÂà∂Âú®Áï´Èù¢ÂÖß
            this.p.x = Math.max(0, Math.min(W-this.p.w, this.p.x));
            this.p.y = Math.max(0, Math.min(H-this.p.h, this.p.y));

            // 2. Â∞ÑÊìä (Êåâ A Êàñ B)
            if(this.p.cd > 0) this.p.cd--;
            if((Inp.a || Inp.b) && this.p.cd <= 0) {
                this.bulls.push({x:this.p.x+this.p.w/2-3, y:this.p.y, w:6, h:15, c:'#4dabf7'});
                this.p.cd = 12; // Â∞ÑÊìäÂÜ∑Âçª
            }

            // 3. Êïµ‰∫∫ÁîüÊàê
            if(Math.random() < this.freq) {
                this.enems.push({
                    x: Math.random() * (W-40),
                    y: -40,
                    w: 30 + Math.random()*10,
                    h: 30 + Math.random()*10,
                    vy: 2 + Math.random() * 2 + (this.blv*0.2), // ÂûÇÁõ¥ÈÄüÂ∫¶
                    vx: (Math.random()-0.5) * 2, // Ê∞¥Âπ≥È£ÑÁßª
                    hp: 1 + Math.floor(this.sc/100)
                });
            }

            // 4. Êõ¥Êñ∞Â≠êÂΩà
            for(let i=this.bulls.length-1; i>=0; i--) {
                let b = this.bulls[i];
                b.y -= 10;
                if(b.y < -20) this.bulls.splice(i, 1);
            }

            // 5. Êõ¥Êñ∞Êïµ‰∫∫ & Á¢∞Êíû
            for(let i=this.enems.length-1; i>=0; i--) {
                let e = this.enems[i];
                e.y += e.vy;
                e.x += e.vx;
                
                // Á¢∞Âà∞ÈÇäÁïåÂèçÂΩà (Ê∞¥Âπ≥)
                if(e.x < 0 || e.x > W-e.w) e.vx *= -1;

                // Á¢∞Âà∞Áé©ÂÆ∂ -> Ê≠ª‰∫°
                if(this.hit(this.p, {x:e.x+5, y:e.y+5, w:e.w-10, h:e.h-10})) {
                    this.hurt(30);
                    this.enems.splice(i, 1);
                    this.boom(e.x, e.y, '#ff6b6b', 10);
                    continue;
                }

                // Ë¢´Â≠êÂΩàÊâì‰∏≠
                let hit = false;
                for(let j=this.bulls.length-1; j>=0; j--) {
                    let b = this.bulls[j];
                    if(this.hit(b, e)) {
                        e.hp--;
                        this.bulls.splice(j, 1); // Â≠êÂΩàÊ∂àÂ§±
                        if(e.hp <= 0) {
                            hit = true;
                            this.sc += 10;
                            this.boom(e.x, e.y, '#ffd43b', 8);
                        }
                        break;
                    }
                }
                
                if(hit) {
                    this.enems.splice(i, 1);
                    continue;
                }

                // Ë∂ÖÂá∫Â∫ïÈÉ®
                if(e.y > H) {
                    this.enems.splice(i, 1);
                }
            }

            // 6. Á≤íÂ≠êËàáÂãùÂà©
            this.parts.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.l--; });
            this.parts = this.parts.filter(p => p.l > 0);
            
            if(this.sc >= 300 + (this.blv*100)) this.win();
        }

        drw() {
            // Áï´ËÉåÊôØ (Á∞°ÂñÆÊòüÁ©∫)
            Ctx.fillStyle = '#000';
            Ctx.fillRect(0,0,W,H);
            if(Math.random()<0.2) Ctx.fillStyle='#fff'; else Ctx.fillStyle='#444';
            for(let i=0;i<5;i++) Ctx.fillRect(Math.random()*W, Math.random()*H, 2, 2);

            // Áï´Áé©ÂÆ∂ (‰∏âËßíÂΩ¢Êà∞Ê©ü)
            Ctx.fillStyle = '#4dabf7';
            Ctx.beginPath();
            Ctx.moveTo(this.p.x + this.p.w/2, this.p.y);
            Ctx.lineTo(this.p.x + this.p.w, this.p.y + this.p.h);
            Ctx.lineTo(this.p.x, this.p.y + this.p.h);
            Ctx.fill();
            // Âô¥Â∞ÑÁÅ´ÁÑ∞
            Ctx.fillStyle = '#fcc419';
            Ctx.fillRect(this.p.x+10, this.p.y+30, 10, Math.random()*15+5);

            // Áï´Êïµ‰∫∫
            this.enems.forEach(e => {
                this.de(e.x, e.y, e.w, e.h, '#ff6b6b');
                // Êïµ‰∫∫ÂúñÊ°à
                Ctx.fillStyle = '#333';
                Ctx.fillRect(e.x+5, e.y+10, 5, 5);
                Ctx.fillRect(e.x+e.w-10, e.y+10, 5, 5);
            });

            // Áï´Â≠êÂΩà
            this.bulls.forEach(b => {
                Ctx.fillStyle = b.c;
                Ctx.fillRect(b.x, b.y, b.w, b.h);
            });

            // Áï´Á≤íÂ≠ê
            this.parts.forEach(p => { Ctx.fillStyle=p.c; Ctx.fillRect(p.x,p.y,3,3); });
        }
        
        boom(x,y,c,n) {
            for(let i=0; i<n; i++) this.parts.push({x:x, y:y, vx:(Math.random()-0.5)*8, vy:(Math.random()-0.5)*8, l:15, c:c});
        }
    };

    // --- ËÆäÈ´îÈÅäÊà≤‰øÆÊ≠£ ---

    // 32: Â§ñÊòüÂÖ•‰æµ (Êïµ‰∫∫Êõ¥Â§öÔºåÈÄüÂ∫¶Êõ¥Âø´)
    GC[32] = class extends GC[6] {
        init() {
            super.init();
            this.freq *= 1.5; // Êïµ‰∫∫Âá∫ÁèæÈ†ªÁéáÂ¢ûÂä† 50%
        }
    };

    // 40: ÁµÇÊ•µÈ≠îÁéã (Boss Êà∞Ê¶ÇÂøµ)
    GC[40] = class extends GC[6] {
        rst() {
            super.rst();
            // Âè™Êúâ‰∏ÄÂÄãÂ§ß Boss
            this.boss = {x:W/2-40, y:20, w:80, h:80, hp:50 + (this.blv*20), max:50+(this.blv*20), vx:2};
        }
        upd() {
            super.upd();
            // Ë¶ÜËìãÊïµ‰∫∫ÁîüÊàêÈÇèËºØÔºåÂè™ËôïÁêÜ Boss
            this.enems = []; 
            
            let b = this.boss;
            if(b.hp > 0) {
                b.x += b.vx;
                if(b.x < 0 || b.x > W-b.w) b.vx *= -1;
                
                // Boss ÁôºÂ∞ÑÂ≠êÂΩà
                if(Math.random() < 0.05) {
                   this.enems.push({x:b.x+40, y:b.y+80, w:10, h:10, vy:5, vx:0, hp:100}); // ÂÄüÁî® enems Èô£ÂàóÊîæÂ≠êÂΩà
                }

                // Ê™¢Êü•Áé©ÂÆ∂Â≠êÂΩàÊòØÂê¶Êâì‰∏≠ Boss
                for(let j=this.bulls.length-1; j>=0; j--) {
                    let bu = this.bulls[j];
                    if(this.hit(bu, b)) {
                        b.hp--;
                        this.bulls.splice(j, 1);
                        this.boom(bu.x, bu.y, '#fff', 2);
                        if(b.hp <= 0) {
                            this.win();
                            this.boom(b.x, b.y, '#f00', 50);
                        }
                    }
                }
            }
        }
        drw() {
            super.drw();
            if(this.boss.hp > 0) {
                this.de(this.boss.x, this.boss.y, this.boss.w, this.boss.h, '#e03131');
                // Ë°ÄÊ¢ù
                Ctx.fillStyle = '#444'; Ctx.fillRect(this.boss.x, this.boss.y-10, this.boss.w, 6);
                Ctx.fillStyle = '#f00'; Ctx.fillRect(this.boss.x, this.boss.y-10, this.boss.w * (this.boss.hp/this.boss.max), 6);
            }
        }
    };

    // 22: Ê∞£ÁêÉÈò≤Ë°õ (È°û‰ººÂ§™Á©∫Êà∞Ôºå‰ΩÜ‰∏çËÉΩÊºèÊéâÊïµ‰∫∫)
    GC[22] = class extends GC[6] {
        rst() {
            super.rst();
            this.enems = [];
        }
        upd() {
            // ÂÄüÁî®Áà∂È°ûÂà•ÈÇèËºØÔºå‰ΩÜ‰øÆÊîπÊºèÊé•Âà§Êñ∑
            super.upd();
            // Ê™¢Êü•ÂâõÂâõÊòØÂê¶ÊúâÊïµ‰∫∫Âõ†ÁÇ∫Ë∂ÖÂá∫Â∫ïÈÉ®ËÄåË¢´ÁßªÈô§ (Âú®Áà∂È°ûÂà•ÈÄôÂè™ÊúÉÂñÆÁ¥îÁßªÈô§)
            // ÈÄôË£°ÊàëÂÄëÈúÄË¶ÅË¶ÜÂØ´ÈÇèËºØÊØîËºÉÈ∫ªÁÖ©Ôºå‰∏çÂ¶ÇÁõ¥Êé•Âú® drw Áï´‰∏ÄÊ¢ùÁ¥ÖÁ∑öË°®Á§∫Èò≤Ë°õÁ∑ö
        }
        drw() {
            super.drw();
            Ctx.fillStyle = 'rgba(255,0,0,0.3)';
            Ctx.fillRect(0, H-10, W, 10); // Â∫ïÈÉ®Á¥ÖÁ∑ö
        }
    };

    console.log("Â§™Á©∫Â§ßÊà∞Á≥ªÂàó‰øÆÂæ©Ë£ú‰∏ÅÂ∑≤Âä†Ëºâ");
})();
</script>
<script>
// --- Â∞ÑÊìäÈÅäÊà≤ÁàΩÂø´Áâà‰øÆÂæ©Ë£ú‰∏Å (Super Shooter Fix) ---
(function() {
    
    // ÈÄöÁî®Á¢∞ÊíûÊ™¢Ê∏¨ÂáΩÊï∏ (Á¢∫‰øùÂà§ÂÆöÊ∫ñÁ¢∫)
    function checkHit(r1, r2) {
        return !(r2.x > r1.x + r1.w || 
                 r2.x + r2.w < r1.x || 
                 r2.y > r1.y + r1.h || 
                 r2.y + r2.h < r1.y);
    }

    // ==========================================
    // 1. Â§™Á©∫Â§ßÊà∞ (Space War) - ID 6
    // ==========================================
    GC[6] = class extends GBase {
        rst() {
            this.p = { x: W/2, y: H-80, w: 40, h: 40, cd: 0 }; // Áé©ÂÆ∂ËÆäÂ§ß
            this.bulls = [];
            this.enems = [];
            this.parts = [];
            // Èõ£Â∫¶Ë®≠ÂÆöÔºöÊØè 1000 ÂàÜÊâçÂ¢ûÂä†‰∏ÄÈªûÈªûÁîüÊàêÁéá
            this.freq = 0.02; 
        }

        upd() {
            // ÁßªÂãï (ÈÄüÂ∫¶Âä†Âø´)
            let spd = 6;
            if(Inp.l) this.p.x -= spd;
            if(Inp.r) this.p.x += spd;
            if(Inp.u) this.p.y -= spd;
            if(Inp.d) this.p.y += spd;
            this.p.x = Math.max(0, Math.min(W-this.p.w, this.p.x));
            this.p.y = Math.max(0, Math.min(H-this.p.h, this.p.y));

            // Â∞ÑÊìä (Ë∂ÖÈ´òÈÄüÈÄ£Áôº)
            if(this.p.cd > 0) this.p.cd--;
            // Âè™Ë¶ÅÊåâËëó A Êàñ B Â∞±Â∞ÑÊìäÔºåÂÜ∑ÂçªÂè™Êúâ 5 ÂπÄ (Á¥Ñ 0.08Áßí‰∏ÄÁôº)
            if((Inp.a || Inp.b) && this.p.cd <= 0) {
                // Áî¢ÁîüÂÖ©ÂÄãÂ≠êÂΩà (ÈõôÁôº)
                this.bulls.push({x:this.p.x, y:this.p.y, w:8, h:20, c:'#4dabf7'});
                this.bulls.push({x:this.p.x+this.p.w-8, y:this.p.y, w:8, h:20, c:'#4dabf7'});
                this.p.cd = 6; 
            }

            // Êïµ‰∫∫ÁîüÊàê
            if(Math.random() < this.freq) {
                this.enems.push({
                    x: Math.random() * (W-40),
                    y: -50,
                    w: 35, h: 35,
                    vx: (Math.random()-0.5) * 2,
                    vy: 2 + Math.random(), // ÈÄüÂ∫¶Ê∏õÊÖ¢
                    hp: 1 // Ë°ÄÈáèÂõ∫ÂÆöÁÇ∫ 1Ôºå‰∏ÄÊìäÂøÖÊÆ∫
                });
            }

            // Â≠êÂΩàÊõ¥Êñ∞
            for(let i=this.bulls.length-1; i>=0; i--) {
                let b = this.bulls[i];
                b.y -= 12; // Â≠êÂΩàÊ•µÂø´
                if(b.y < -30) this.bulls.splice(i, 1);
            }

            // Êïµ‰∫∫Êõ¥Êñ∞ & Á¢∞Êíû
            for(let i=this.enems.length-1; i>=0; i--) {
                let e = this.enems[i];
                e.x += e.vx;
                e.y += e.vy;

                // ÈÇäÁïåÂèçÂΩà
                if(e.x < 0 || e.x > W-e.w) e.vx *= -1;

                // ÊíûÂà∞Áé©ÂÆ∂ (Êâ£Ë°Ä)
                if(checkHit(this.p, {x:e.x+5, y:e.y+5, w:e.w-10, h:e.h-10})) {
                    this.hurt(10); // ÂÇ∑ÂÆ≥Èôç‰Ωé
                    this.enems.splice(i, 1);
                    this.boom(e.x, e.y, '#ff6b6b', 10);
                    continue;
                }

                // Â≠êÂΩàÂà§ÂÆö
                let dead = false;
                for(let j=this.bulls.length-1; j>=0; j--) {
                    let b = this.bulls[j];
                    // Êì¥Â§ßÂà§ÂÆöÁØÑÂúçÔºöÂ≠êÂΩàÁ¢∞Âà∞Êïµ‰∫∫Â∞±Ê≠ª
                    if(checkHit(b, e)) {
                        e.hp--;
                        this.bulls.splice(j, 1);
                        if(e.hp <= 0) {
                            dead = true;
                            this.sc += 10;
                            this.boom(e.x, e.y, '#ffd43b', 10);
                        }
                        break;
                    }
                }
                
                if(dead) {
                    this.enems.splice(i, 1);
                    continue;
                }

                if(e.y > H) this.enems.splice(i, 1);
            }

            // Á≤íÂ≠ê
            this.parts.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.l--; });
            this.parts = this.parts.filter(p => p.l > 0);

            if(this.sc >= 500) this.win();
        }

        drw() {
            Ctx.fillStyle = '#111'; Ctx.fillRect(0,0,W,H); // ËÉåÊôØ
            // Áï´Áé©ÂÆ∂
            this.de(this.p.x, this.p.y, this.p.w, this.p.h, '#4dabf7');
            Ctx.fillStyle = '#fcc419'; Ctx.fillRect(this.p.x+10, this.p.y+40, 6, 10); Ctx.fillRect(this.p.x+24, this.p.y+40, 6, 10);
            
            // Áï´Êïµ‰∫∫
            this.enems.forEach(e => {
                this.de(e.x, e.y, e.w, e.h, '#ff6b6b');
                // Áï´ÂÄã X ‰ª£Ë°®Êïµ‰∫∫
                Ctx.strokeStyle = '#333'; Ctx.beginPath(); 
                Ctx.moveTo(e.x, e.y); Ctx.lineTo(e.x+e.w, e.y+e.h);
                Ctx.moveTo(e.x+e.w, e.y); Ctx.lineTo(e.x, e.y+e.h); Ctx.stroke();
            });

            // Áï´Â≠êÂΩà
            Ctx.fillStyle = '#74c0fc';
            this.bulls.forEach(b => Ctx.fillRect(b.x, b.y, b.w, b.h));

            // Áï´Á≤íÂ≠ê
            this.parts.forEach(p => { Ctx.fillStyle=p.c; Ctx.fillRect(p.x,p.y,3,3); });
        }
        
        boom(x,y,c,n) {
            for(let i=0; i<n; i++) this.parts.push({x:x+15, y:y+15, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, l:15, c:c});
        }
    };

    // ==========================================
    // 2. Âü∫Âú∞Èò≤Á¶¶ (Base Defense) - ID 16
    // ==========================================
    GC[16] = class extends GC[6] {
        rst() {
            super.rst();
            this.p.y = H - 60; // Áé©ÂÆ∂‰ΩçÁΩÆ
            this.freq = 0.015; // Êïµ‰∫∫ËºÉÂ∞ë
        }
        
        upd() {
            super.upd();
            // Âü∫Âú∞Èò≤Á¶¶ÁâπÊúâÔºöÊïµ‰∫∫Âà∞Â∫ïÈÉ®ÊúÉÊâ£Â§ßË°Ä
            // (Áà∂È°ûÂà•Âè™ÊúÉÂà™Èô§Êïµ‰∫∫ÔºåÈÄôË£°ÊàëÂÄëÂú®Áà∂È°ûÂà•ÈÇèËºØÂ§ñÁÑ°Ê≥ïÁ∞°ÂñÆÊîîÊà™Ôºå
            // ‰ΩÜÂõ†ÁÇ∫Áà∂È°ûÂà•Â∑≤Á∂ìÂ§†Á∞°ÂñÆ‰∫ÜÔºåÈÄôË£°ÊàëÂÄëÊîπÂØ´ drw Â¢ûÂä†‰∏ÄÊ¢ùÈò≤Á∑öË¶ñË¶∫Â∞±Â•Ω)
            // Â¶ÇÊûúÊÇ®Ë¶∫ÂæóÂ§™Èõ£ÔºåÊàëÂÄëÂèØ‰ª•ÂèñÊ∂à„ÄåÊºèÊÄ™Êâ£Ë°Ä„ÄçÁöÑË®≠ÂÆöÔºåÊîπÊàêÁ¥îÂ∞ÑÊìäÁàΩGame
        }

        drw() {
            super.drw();
            Ctx.fillStyle = '#51cf66'; // Â∫ïÈÉ®Âü∫Âú∞
            Ctx.fillRect(0, H-20, W, 20);
        }
    };

    // ÁπºÊâø‰øÆÂæ©ÂÖ∂‰ªñËÆäÈ´î
    GC[32] = class extends GC[6] {}; // Â§ñÊòüÂÖ•‰æµ
    GC[40] = class extends GC[6] {   // ÁµÇÊ•µÈ≠îÁéã (Boss ÊîπÂº±)
        rst() { super.rst(); this.boss = {x:W/2-40, y:20, w:80, h:80, hp:30, vx:2}; this.enems=[]; }
        upd() {
            // Á∞°ÂñÆÁöÑ Boss ÈÇèËºØ
            let b = this.boss;
            if(b.hp > 0) {
                b.x += b.vx;
                if(b.x < 0 || b.x > W-b.w) b.vx *= -1;
                
                // Boss Ë¢´Êâì
                for(let j=this.bulls.length-1; j>=0; j--) {
                    let bu = this.bulls[j];
                    if(checkHit(bu, b)) {
                        b.hp--;
                        this.bulls.splice(j, 1);
                        this.boom(bu.x, bu.y, '#fff', 5);
                        if(b.hp <= 0) { this.win(); this.boom(b.x, b.y, '#f00', 100); }
                    }
                }
            }
            // Áé©ÂÆ∂ÁßªÂãïËàáÁ≤íÂ≠êÊõ¥Êñ∞‰øùÁïô
            let spd = 6;
            if(Inp.l) this.p.x -= spd; if(Inp.r) this.p.x += spd;
            this.p.x = Math.max(0, Math.min(W-this.p.w, this.p.x));
            
            this.parts.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.l--; });
            this.parts = this.parts.filter(p => p.l > 0);
            
            // Áé©ÂÆ∂Â∞ÑÊìä
            if(this.p.cd > 0) this.p.cd--;
            if((Inp.a || Inp.b) && this.p.cd <= 0) {
                this.bulls.push({x:this.p.x+15, y:this.p.y, w:10, h:20, c:'#4dabf7'});
                this.p.cd = 6;
            }
            // Êõ¥Êñ∞Â≠êÂΩà
             for(let i=this.bulls.length-1; i>=0; i--) {
                let bu = this.bulls[i]; bu.y -= 12; if(bu.y < -30) this.bulls.splice(i, 1);
            }
        }
        drw() {
            Ctx.fillStyle = '#111'; Ctx.fillRect(0,0,W,H);
            if(this.boss.hp>0) this.de(this.boss.x, this.boss.y, this.boss.w, this.boss.h, '#e03131');
            this.de(this.p.x, this.p.y, 40, 40, '#4dabf7');
            Ctx.fillStyle='#74c0fc'; this.bulls.forEach(b=>Ctx.fillRect(b.x,b.y,b.w,b.h));
            this.parts.forEach(p => { Ctx.fillStyle=p.c; Ctx.fillRect(p.x,p.y,3,3); });
        }
    };

    console.log("Â∞ÑÊìäÈÅäÊà≤ÁàΩÂø´Áâà (Super Shooter) Â∑≤Âä†Ëºâ - Â≠êÂΩàÂ¢ûÂº∑/Êïµ‰∫∫ËÆäÂº±");
})();
</script>
<script>
// --- ÁÑ°ÈôêÈóñÈóúÊ®°ÂºèË£ú‰∏Å (Infinite Levels Patch) ---
(function() {
    console.log("ÁÑ°ÈôêÈóñÈóúÊ®°ÂºèÂ∑≤ÂïüÂãïÔºÅ");

    // 1. Ë¶ÜËìãÂéüÊú¨ÁöÑ GBase.win (ÂãùÂà©) ÂáΩÂºè
    // ÂéüÊú¨ÊòØÁõ¥Êé•ÁµêÊùüÔºåÁèæÂú®ÊîπÊàêÈÄ≤ÂÖ•‰∏ã‰∏ÄÈóú
    GBase.prototype.win = function() {
        // Êö´ÂÅúÈÅäÊà≤Ëø¥ÂúàÔºåÈÅøÂÖçÈáçË§áËß∏Áôº
        window.Eng.stop(); 
        
        // ÈóúÂç°Êï∏ +1
        this.st++; 
        
        // ÁçéÂãµÊ©üÂà∂ (ÊØèÈÅé‰∏ÄÈóúË£úË°Ä„ÄÅÂä†ÂàÜ)
        this.sc += 100 * this.st; // ÈÅéÈóúÂä†ÂàÜ
        window.Sys.u.coins += 50; // ÈÅéÈóúË≥∫ÈáëÂπ£
        
        // È°ØÁ§∫ÈÅéÈóúË®äÊÅØ (‰ΩøÁî®ÂéüÊú¨ÁöÑ Modal ‰ªãÈù¢)
        window.Layer.modal(
            `<span style="color:#51cf66">LEVEL ${this.st-1} ÂÆåÊàêÔºÅ</span>`, 
            `Èõ£Â∫¶ÊèêÂçáÔºÅÊ∫ñÂÇôÈÄ≤ÂÖ•Á¨¨ <b style="color:#ffd43b; font-size:1.5rem">${this.st}</b> Èóú<br>
             <span style="font-size:0.8rem; color:#aaa">Êïµ‰∫∫ËÆäÂø´ / Êï∏ÈáèËÆäÂ§ö</span>`, 
            `<button class="primary" id="btn-next-lv" style="width:100%; padding:15px; font-size:1.2rem;">
                ÁπºÁ∫åÊåëÊà∞ (Level ${this.st})
             </button>`
        );

        // Êåâ‰∏ãÊåâÈàïÂæåÁöÑÂãï‰Ωú
        document.getElementById('btn-next-lv').onclick = () => {
            window.Layer.close(); // ÈóúÈñâË¶ñÁ™ó
            
            // 2. ÈáçÊñ∞Ë®≠ÂÆöÈóúÂç°ÁãÄÊÖã (ÈÄôÊúÉËß∏Áôº rst() ÈáçÁΩÆÊïµ‰∫∫Ôºå‰ΩÜ‰øùÁïô level)
            // Ê†πÊìöÈóúÂç°Êï∏Ë™øÊï¥Èõ£Â∫¶‰øÇÊï∏ (mod)
            // this.blv ÊòØÂü∫Á§éÈõ£Â∫¶, this.st ÊòØÁï∂ÂâçÈóúÂç°
            this.mod = (this.blv * 0.5) + (this.st * 0.25); 
            
            // ÂëºÂè´ÈÅäÊà≤ÈáçÁΩÆ (Reset)
            this.rst(); 
            
            // È°çÂ§ñÈõ£Â∫¶Ë™øÊï¥ (ÈáùÂ∞ç‰∏çÂêåÈÅäÊà≤È°ûÂûãÂæÆË™ø)
            // Â¶ÇÊûúÊòØÂ∞ÑÊìäÈ°ûÔºåÂèØ‰ª•Â¢ûÂä†Êïµ‰∫∫Ë°ÄÈáè
            if(this.enems) {
                // ËÆì‰∏ã‰∏ÄÊ≥¢Êïµ‰∫∫Êõ¥Âº∑
                this.wave_hp_bonus = (this.st - 1) * 2; 
            }
            // Á®çÂæÆË£úË°Ä (ÁçéÂãµ)
            this.hp = Math.min(this.hp + 30, window.Sys.has('maxhp') ? 150 : 100);
            
            // Êõ¥Êñ∞‰ªãÈù¢È°ØÁ§∫
            document.getElementById('g-st').innerText = this.st;
            window.toast(`Á¨¨ ${this.st} Èóú ÈñãÂßãÔºÅ`);
            
            // 3. ÁπºÁ∫åÈÅäÊà≤Ëø¥Âúà
            window.Eng.loop();
        };
    };

    // 2. ÈáùÂ∞çÁâπÂÆöÈÅäÊà≤ÁöÑ„Äå‰∏ã‰∏ÄÈóú„ÄçÈÇèËºØÂæÆË™ø (ÂèØÈÅ∏)
    // ËÆìÊüê‰∫õÈÅäÊà≤ÁöÑ "sc" (ÂàÜÊï∏/ÈÄ≤Â∫¶) Âú® rst() ÊôÇÊ≠∏Èõ∂ÔºåÈÄôÊ®£ÊâçËÉΩÈáçÊñ∞Ë∑ëÈÄ≤Â∫¶Ê¢ù
    // ÂéüÊú¨ÁöÑ rst() Â§ßÂ§öÂ∑≤Á∂ìÊúâ this.sc = 0ÔºåÊâÄ‰ª•Â§ßÈÉ®ÂàÜÈÅäÊà≤Áõ¥Êé•ÈÅ©Áî®ÔºÅ

})();
</script>
</body>
</html>
